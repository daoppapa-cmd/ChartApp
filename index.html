<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>á€á˜áŸ’á˜áœá·á’á¸á‡á‡áŸ‚á€á€á˜áŸ’áŸá¶á“áŸ’á</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Font: Battambang -->
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Battambang', cursive; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .message-bubble { transition: all 0.2s; user-select: none; -webkit-user-select: none; }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-content { animation: slideIn 0.3s ease-out forwards; }
        @keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .recording-pulse { animation: pulse-red 1.5s infinite; }
        
        /* Custom Audio Player Styling Fixes */
        audio { height: 40px; border-radius: 20px; }
        /* Video max height */
        video { max-height: 300px; object-fit: contain; background: #000; }
        
        /* Input transition */
        .input-area-transition { transition: all 0.3s ease; }
        
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }

        /* Call Animation */
        @keyframes ripple {
            0% { transform: scale(1); opacity: 0.4; }
            100% { transform: scale(2); opacity: 0; }
        }
        .ripple-effect::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 50%; background-color: white; z-index: -1;
            animation: ripple 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden">
    <div id="root" class="h-full w-full fixed inset-0"></div>

    <!-- Firebase Configuration & Setup -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getDatabase, ref, push, set, onValue, update, remove, get, child, query, orderByChild, equalTo, onDisconnect, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js';

        window.fb = {
            initializeApp, getDatabase, ref, push, set, onValue, update, remove, get, child, query, orderByChild, equalTo, onDisconnect, serverTimestamp
        };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <!-- React Application Logic -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CLOUDINARY CONFIGURATION ---
        const CLOUDINARY_CLOUD_NAME = 'dylbvcpoh'; 
        const CLOUDINARY_UPLOAD_PRESET = 'kdhg1tro';

        // --- Icons ---
        const SendIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>);
        const Loader2Icon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>);
        const SearchIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>);
        const ArrowLeftIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>);
        const UserIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>);
        const UsersIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>);
        const TrashIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>);
        const XIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>);
        const CheckIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"></polyline></svg>);
        const LogoutIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>);
        const LockIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>);
        const SettingsIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>);
        const CopyIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>);
        const UserMinusIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="23" y1="11" x2="17" y2="11"></line></svg>);
        const LeaveIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>);
        const ImageIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>);
        const VideoIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>);
        const MicIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>);
        const StopCircleIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><rect x="9" y="9" width="6" height="6"></rect></svg>);
        const PlusCircleIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>);
        const Edit2Icon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>);
        const PhoneIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>);
        const VideoCallIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>);
        const EyeIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>);
        const CheckDoubleIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 12l5 5L17 7"></path><path d="M12 5l5 5L22 7"></path></svg>);
        const PhoneOffIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7 2 2 0 0 1 1.72 2v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.42 19.42 0 0 1-3.33-2.67m-2.67-3.34a19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>);

        function LoginView({ onRegister, onLogin }) {
            const [mode, setMode] = useState('register'); 
            const [name, setName] = useState('');
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');

            return (
                <div className="flex items-center justify-center h-full bg-gray-50 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
                        <div className="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6"><svg className="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg></div>
                        <div className="flex bg-gray-100 rounded-lg p-1 mb-6"><button onClick={() => setMode('register')} className={`flex-1 py-2 rounded-md text-sm font-bold transition ${mode === 'register' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>á…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡</button><button onClick={() => setMode('login')} className={`flex-1 py-2 rounded-md text-sm font-bold transition ${mode === 'login' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>á…á¼á›á”áŸ’ášá¾</button></div>
                        {mode === 'register' ? (
                            <form onSubmit={(e) => { e.preventDefault(); onRegister(name); }}>
                                <h1 className="text-xl font-bold text-gray-800 mb-2">á”á„áŸ’á€á¾áá‚áá“á¸ááŸ’á˜á¸</h1>
                                <p className="text-gray-500 mb-6 text-sm">á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡ášá”áŸáŸ‹á¢áŸ’á“á€áŠá¾á˜áŸ’á”á¸á…á¶á”áŸ‹á•áŸ’áá¾á˜</p>
                                <input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="áˆáŸ’á˜áŸ„áŸ‡ášá”áŸáŸ‹á¢áŸ’á“á€..." className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl mb-4 focus:ring-2 focus:ring-blue-500 outline-none transition" autoFocus />
                                <button type="submit" disabled={!name.trim()} className="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl hover:bg-blue-700 transition shadow-lg disabled:opacity-50">áŸáŸ’á“á¾áŸá»áŸ†á”á¾á€á‚áá“á¸</button>
                            </form>
                        ) : (
                            <form onSubmit={(e) => { e.preventDefault(); onLogin(name, username, password); }}>
                                <h1 className="text-xl font-bold text-gray-800 mb-2">á…á¼á›á”áŸ’ášá¾á‚áá“á¸</h1>
                                <p className="text-gray-500 mb-6 text-sm">á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡ á“á·á„ Username</p>
                                <input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="áˆáŸ’á˜áŸ„áŸ‡..." className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl mb-3 focus:ring-2 focus:ring-blue-500 outline-none transition" />
                                <input type="text" value={username} onChange={(e) => setUsername(e.target.value)} placeholder="Username (@...)" className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl mb-3 focus:ring-2 focus:ring-blue-500 outline-none transition" />
                                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Password (á”áŸ’ášáŸá·á“á”á¾á…á¶áŸ†á”á¶á…áŸ‹)" className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl mb-4 focus:ring-2 focus:ring-blue-500 outline-none transition" />
                                <button type="submit" disabled={!name.trim() || !username.trim()} className="w-full bg-green-600 text-white font-bold py-3.5 rounded-xl hover:bg-green-700 transition shadow-lg disabled:opacity-50">á…á¼á›á”áŸ’ášá¾</button>
                            </form>
                        )}
                    </div>
                </div>
            );
        }

        // --- Incoming Call Component ---
        function IncomingCallModal({ call, onAnswer, onDecline }) {
            return (
                <div className="absolute inset-0 z-50 bg-gray-900/90 flex flex-col items-center justify-center text-white p-4 animate-slideIn">
                    <div className="w-32 h-32 rounded-full bg-gray-700 flex items-center justify-center mb-6 ripple-effect relative">
                        {call.caller.photoUrl ? (
                            <img src={call.caller.photoUrl} className="w-28 h-28 rounded-full object-cover z-10" />
                        ) : (
                            <div className="w-24 h-24 rounded-full overflow-hidden bg-gray-500 z-10 flex items-center justify-center"><UserIcon className="w-12 h-12"/></div>
                        )}
                    </div>
                    <h2 className="text-2xl font-bold mb-1">{call.caller.name}</h2>
                    <p className="text-gray-300 mb-12 animate-pulse">
                        {call.type === 'video' ? 'á€áŸ†á–á»á„á áŸ…áœá¸áŠáŸá¢á¼...' : 'á€áŸ†á–á»á„á áŸ…áŸáŸ†á¡áŸá„...'} 
                        {call.target.type === 'group' && <span className="block text-sm mt-1 text-gray-400">á–á¸á€áŸ’ášá»á˜: {call.target.name}</span>}
                    </p>
                    
                    <div className="flex gap-8">
                         <button onClick={onDecline} className="flex flex-col items-center gap-2">
                            <div className="p-4 bg-red-600 rounded-full hover:bg-red-700 shadow-lg transition transform hover:scale-110">
                                <PhoneOffIcon className="w-8 h-8" />
                            </div>
                            <span className="text-sm font-medium">á”áŠá·áŸáŸá’</span>
                        </button>
                        <button onClick={onAnswer} className="flex flex-col items-center gap-2">
                            <div className="p-4 bg-green-500 rounded-full hover:bg-green-600 shadow-lg transition transform hover:scale-110 animate-bounce">
                                {call.type === 'video' ? <VideoCallIcon className="w-8 h-8" /> : <PhoneIcon className="w-8 h-8" />}
                            </div>
                            <span className="text-sm font-medium">á‘á‘á½á›</span>
                        </button>
                    </div>
                </div>
            );
        }

        // --- Active Call Component ---
        function ActiveCallModal({ call, currentUser, onEndCall }) {
            const [cameraOn, setCameraOn] = useState(true);
            const [micOn, setMicOn] = useState(true);
            const localVideoRef = useRef(null);

            useEffect(() => {
                let localStream;
                const startStream = async () => {
                    try {
                        if (call.type === 'video' && cameraOn) {
                            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                            if (localVideoRef.current) localVideoRef.current.srcObject = localStream;
                        } else if (micOn) {
                            // Just audio if video off or audio call
                             localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        }
                    } catch(e) { console.error("Stream error", e); }
                };
                startStream();
                return () => { if(localStream) localStream.getTracks().forEach(track => track.stop()); };
            }, [cameraOn, micOn, call.type]);

            const participants = call.participants ? Object.keys(call.participants).length : 1;

            return (
                <div className="absolute inset-0 z-50 bg-gray-900 flex flex-col text-white">
                    {/* Header */}
                    <div className="absolute top-0 left-0 right-0 p-4 flex justify-between items-center z-10 bg-gradient-to-b from-black/50 to-transparent">
                         <div className="flex items-center gap-2">
                            <div className="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-xs">{call.target.name[0]}</div>
                            <div>
                                <h3 className="font-bold text-sm">{call.target.name}</h3>
                                <p className="text-xs text-gray-300">{call.status === 'active' ? (participants > 1 ? `${participants} á“á¶á€áŸ‹á“áŸ…á€áŸ’á“á»á„á€á¶ášá áŸ…` : 'á€áŸ†á–á»á„á—áŸ’á‡á¶á”áŸ‹...') : 'á€áŸ†á–á»á„á áŸ…...'}</p>
                            </div>
                         </div>
                    </div>

                    {/* Main Video Area (Simulation) */}
                    <div className="flex-1 flex items-center justify-center relative bg-gray-800 overflow-hidden">
                         {/* If Video Call, show local camera (Self View) */}
                         {call.type === 'video' && cameraOn ? (
                             <video ref={localVideoRef} autoPlay muted playsInline className="absolute inset-0 w-full h-full object-cover" />
                         ) : (
                             <div className="flex flex-col items-center">
                                 <div className="w-24 h-24 rounded-full bg-gray-600 flex items-center justify-center mb-4">
                                     {call.caller.photoUrl ? <img src={call.caller.photoUrl} className="w-full h-full rounded-full object-cover"/> : <UserIcon className="w-12 h-12"/>}
                                 </div>
                                 <p className="text-xl">{call.caller.name}</p>
                             </div>
                         )}
                         
                         {/* Simulated Remote Video (Placeholder for group) */}
                         {call.type === 'video' && participants > 1 && (
                             <div className="absolute top-20 right-4 w-24 h-32 bg-black rounded-lg border border-white/20 flex items-center justify-center">
                                 <span className="text-xs text-gray-400">á¢áŸ’á“á€á•áŸ’áŸáŸá„...</span>
                             </div>
                         )}
                    </div>

                    {/* Controls */}
                    <div className="p-6 bg-black/40 backdrop-blur-sm flex justify-center items-center gap-6 rounded-t-3xl">
                        <button onClick={() => setMicOn(!micOn)} className={`p-3 rounded-full transition ${micOn ? 'bg-gray-600 hover:bg-gray-500' : 'bg-white text-black'}`}>
                            <MicIcon className="w-6 h-6" />
                        </button>
                        
                        {call.type === 'video' && (
                            <button onClick={() => setCameraOn(!cameraOn)} className={`p-3 rounded-full transition ${cameraOn ? 'bg-gray-600 hover:bg-gray-500' : 'bg-white text-black'}`}>
                                <VideoCallIcon className="w-6 h-6" />
                            </button>
                        )}

                        <button onClick={onEndCall} className="p-4 bg-red-600 rounded-full hover:bg-red-700 shadow-lg transform transition active:scale-95">
                            <PhoneOffIcon className="w-8 h-8" />
                        </button>
                    </div>
                </div>
            );
        }


        function App() {
            const [firebaseReady, setFirebaseReady] = useState(false);
            const [view, setView] = useState('loading');
            const [currentUser, setCurrentUser] = useState(null);
            
            // Data States
            const [directChats, setDirectChats] = useState([]);
            const [myGroupIds, setMyGroupIds] = useState([]);
            const [allGroupsData, setAllGroupsData] = useState({});
            const [allChats, setAllChats] = useState([]);
            
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResult, setSearchResult] = useState(null);
            const [searchError, setSearchError] = useState('');
            const [activeChat, setActiveChat] = useState(null);
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState('');
            const [editingMessageId, setEditingMessageId] = useState(null);
            const [mobileDeleteId, setMobileDeleteId] = useState(null);
            const [isRecording, setIsRecording] = useState(false);
            const [mediaRecorder, setMediaRecorder] = useState(null);
            
            // Modals
            const [showPasswordModal, setShowPasswordModal] = useState(false);
            const [newPassword, setNewPassword] = useState('');
            const [showGroupModal, setShowGroupModal] = useState(false);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [showProfileModal, setShowProfileModal] = useState(false);
            const [isUploadingProfile, setIsUploadingProfile] = useState(false);
            const [showSeenByModal, setShowSeenByModal] = useState(false);
            const [seenByUsers, setSeenByUsers] = useState([]);

            // CALL STATES
            const [incomingCall, setIncomingCall] = useState(null); // The call object received
            const [activeCallSession, setActiveCallSession] = useState(null); // The accepted active call

            const [groupName, setGroupName] = useState('');
            const [groupJoinCode, setGroupJoinCode] = useState('');
            const [groupMembers, setGroupMembers] = useState([]);
            const [groupBlocked, setGroupBlocked] = useState([]);
            const [addMemberQuery, setAddMemberQuery] = useState('');
            
            // UI States
            const [isInputFocused, setIsInputFocused] = useState(false);
            const [uploadingItem, setUploadingItem] = useState(null); 
            const [activeReactionId, setActiveReactionId] = useState(null);
            
            // Partner Status State (Online/Offline)
            const [partnerStatus, setPartnerStatus] = useState(null);

            // Refs
            const appRef = useRef(null);
            const dbRef = useRef(null);
            const messagesEndRef = useRef(null);
            const inputRef = useRef(null);
            const longPressTimerRef = useRef(null);
            const deviceIdRef = useRef(null);
            const imageInputRef = useRef(null);
            const videoInputRef = useRef(null);
            const profileImageInputRef = useRef(null);
            const currentPlayingMediaRef = useRef(null);

            // --- Media Playback Logic ---
            const handleMediaPlay = (event) => {
                const mediaElement = event.target;
                if (currentPlayingMediaRef.current && currentPlayingMediaRef.current !== mediaElement) {
                    currentPlayingMediaRef.current.pause();
                }
                currentPlayingMediaRef.current = mediaElement;
            };

            // 1. Initialize Firebase
            useEffect(() => {
                const initFirebase = () => {
                    if (window.fb) {
                        try {
                            const getFirebaseConfig = () => {
                                let config = {
                                    apiKey: "AIzaSyCPTS4NN_cbPggJBfDveLzBzr6nA5ziVpw",
                                    authDomain: "chartapp-e99be.firebaseapp.com",
                                    projectId: "chartapp-e99be",
                                    databaseURL: "https://chartapp-e99be-default-rtdb.firebaseio.com/"
                                };
                                try {
                                    if (typeof window.__firebase_config !== 'undefined') {
                                        const sysConfig = JSON.parse(window.__firebase_config);
                                        config = { ...config, ...sysConfig };
                                        if (!config.databaseURL) config.databaseURL = "https://chartapp-e99be-default-rtdb.firebaseio.com/";
                                    }
                                } catch (e) { }
                                return config;
                            };
                            const config = getFirebaseConfig();
                            const app = window.fb.initializeApp(config);
                            const db = window.fb.getDatabase(app);
                            appRef.current = app;
                            dbRef.current = db;
                            setFirebaseReady(true);
                            let dId = localStorage.getItem('device_unique_id');
                            if (!dId) {
                                dId = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                                localStorage.setItem('device_unique_id', dId);
                            }
                            deviceIdRef.current = dId;
                        } catch (err) { console.error("Firebase init failed:", err); }
                    }
                };
                if (window.fb) initFirebase();
                else window.addEventListener('firebase-ready', initFirebase);
                return () => window.removeEventListener('firebase-ready', initFirebase);
            }, []);

            // 2. Auth & Presence System
            useEffect(() => {
                if (!firebaseReady) return;
                const checkAuth = async () => {
                    const localUid = localStorage.getItem('chat_app_uid');
                    if (localUid) {
                        const db = dbRef.current;
                        try {
                            const userSnapshot = await window.fb.get(window.fb.ref(db, `users/${localUid}`));
                            if (userSnapshot.exists()) {
                                setCurrentUser({ uid: localUid, ...userSnapshot.val() });
                                setView('home');
                            } else {
                                localStorage.removeItem('chat_app_uid');
                                setView('login');
                            }
                        } catch (e) { setView('login'); }
                    } else { setView('login'); }
                };
                checkAuth();
            }, [firebaseReady]);

            // Presence System Implementation
            useEffect(() => {
                if (!currentUser || !firebaseReady) return;
                const db = dbRef.current;
                const connectedRef = window.fb.ref(db, ".info/connected");
                const userStatusRef = window.fb.ref(db, `users/${currentUser.uid}/status`);
                const userLastSeenRef = window.fb.ref(db, `users/${currentUser.uid}/lastSeen`);

                const unsubscribe = window.fb.onValue(connectedRef, (snap) => {
                    if (snap.val() === true) {
                        window.fb.onDisconnect(userStatusRef).set("offline");
                        window.fb.onDisconnect(userLastSeenRef).set(window.fb.serverTimestamp());
                        
                        window.fb.set(userStatusRef, "online");
                        window.fb.set(userLastSeenRef, window.fb.serverTimestamp());
                    }
                });
                return () => unsubscribe();
            }, [currentUser, firebaseReady]);

            // Listen to Partner Status (Online/Offline)
            useEffect(() => {
                if (view === 'chat' && activeChat && activeChat.type === 'direct' && firebaseReady) {
                    const db = dbRef.current;
                    const statusRef = window.fb.ref(db, `users/${activeChat.partnerId}/status`);
                    const unsubscribe = window.fb.onValue(statusRef, (snapshot) => {
                        if (snapshot.exists()) {
                            setPartnerStatus(snapshot.val());
                        } else {
                            setPartnerStatus('offline');
                        }
                    });
                    return () => unsubscribe();
                } else {
                    setPartnerStatus(null);
                }
            }, [view, activeChat, firebaseReady]);


            // 3. Data Fetching
            useEffect(() => {
                if (view !== 'home' || !currentUser || !firebaseReady) return;
                const db = dbRef.current;
                const userChatsRef = window.fb.ref(db, `user_chats/${currentUser.uid}`);
                const unsubscribe = window.fb.onValue(userChatsRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        setDirectChats(Object.keys(data).map(key => ({ id: key, ...data[key], type: 'direct' })));
                    } else { setDirectChats([]); }
                });
                return () => unsubscribe();
            }, [view, currentUser, firebaseReady]);

            useEffect(() => {
                if (view !== 'home' || !currentUser || !firebaseReady) return;
                const db = dbRef.current;
                const userGroupsRef = window.fb.ref(db, `user_groups/${currentUser.uid}`);
                const unsubscribe = window.fb.onValue(userGroupsRef, (snapshot) => {
                    if (snapshot.exists()) setMyGroupIds(Object.keys(snapshot.val())); else setMyGroupIds([]);
                });
                return () => unsubscribe();
            }, [view, currentUser, firebaseReady]);

            useEffect(() => {
                if (view !== 'home' || !currentUser || !firebaseReady) return;
                const db = dbRef.current;
                const allGroupsRef = window.fb.ref(db, 'groups');
                const unsubscribe = window.fb.onValue(allGroupsRef, (snapshot) => {
                    if (snapshot.exists()) setAllGroupsData(snapshot.val()); else setAllGroupsData({});
                });
                return () => unsubscribe();
            }, [view, currentUser, firebaseReady]);

            useEffect(() => {
                const groupList = myGroupIds.map(gid => allGroupsData[gid] ? { id: gid, ...allGroupsData[gid], type: 'group' } : null).filter(Boolean);
                const merged = [...directChats, ...groupList].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                setAllChats(merged);
            }, [directChats, myGroupIds, allGroupsData]);

            // --- Handlers ---
            // ... (Upload handlers same as before) ...
            const uploadToCloudinary = async (file, resourceType = 'auto') => {
                const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET); 
                try { const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`, { method: 'POST', body: formData }); const data = await res.json(); if(data.error) throw new Error(data.error.message); return data.secure_url; } catch (error) { alert("á”ášá¶á‡áŸá™áŸ– " + error.message); throw error; }
            };

            const handleFileUpload = async (e, type) => {
                const file = e.target.files[0]; if (!file) return;
                const previewUrl = URL.createObjectURL(file); const tempId = 'temp_' + Date.now();
                setUploadingItem({ id: tempId, type, fileUrl: previewUrl, text: type === 'image' ? 'ğŸ“· ášá¼á”á—á¶á–' : 'ğŸ¥ áœá¸áŠáŸá¢á¼', senderId: currentUser.uid, createdAt: Date.now(), status: 'uploading' });
                try { const url = await uploadToCloudinary(file, type); await sendMessageWithMedia(url, type); setUploadingItem(null); } catch(e) { setUploadingItem(null); } finally { e.target.value = null; }
            };
             
             const handleProfilePhotoUpload = async (e) => {
                const file = e.target.files[0]; if(!file) return; setIsUploadingProfile(true);
                try { const url = await uploadToCloudinary(file, 'image'); await window.fb.update(window.fb.ref(dbRef.current, `users/${currentUser.uid}`), { photoUrl: url }); setCurrentUser(prev => ({ ...prev, photoUrl: url })); alert("á”á¶á“á”áŸ’áŠá¼ášášá¼á” Profile á‡áŸ„á‚á‡áŸá™!"); } catch(e) { alert("á”ášá¶á‡áŸá™á€áŸ’á“á»á„á€á¶ášá”áŸ’áŠá¼ášášá¼á”áŸ”"); } finally { setIsUploadingProfile(false); e.target.value = null; }
            };

            const handleChangePassword = async () => {
                if(!newPassword.trim()) { alert("áŸá¼á˜á”á‰áŸ’á…á¼á› Password"); return; }
                try { await window.fb.update(window.fb.ref(dbRef.current, `users/${currentUser.uid}`), { password: newPassword }); setNewPassword(''); alert("Password ááŸ’ášá¼áœá”á¶á“á•áŸ’á›á¶áŸáŸ‹á”áŸ’áá¼áš!"); } catch(e) { alert("á”ášá¶á‡áŸá™áŸ”"); }
            };

            // ... (Recording, Message Sending, Auth handlers same as before) ...
             const startRecording = async () => { try { const stream = await navigator.mediaDevices.getUserMedia({ audio: true }); const recorder = new MediaRecorder(stream); const chunks = []; recorder.ondataavailable = e => chunks.push(e.data); recorder.onstop = async () => { const blob = new Blob(chunks, { type: 'audio/ogg; codecs=opus' }); const previewUrl = URL.createObjectURL(blob); setUploadingItem({ id: 'temp_audio_' + Date.now(), type: 'audio', fileUrl: previewUrl, text: 'ğŸ¤ áŸáŸ†á¡áŸá„', senderId: currentUser.uid, createdAt: Date.now(), status: 'uploading' }); try { const url = await uploadToCloudinary(blob, 'video'); await sendMessageWithMedia(url, 'audio'); setUploadingItem(null); } catch (e) { setUploadingItem(null); } }; recorder.start(); setMediaRecorder(recorder); setIsRecording(true); } catch (err) { alert("á˜á·á“á¢á¶á…á”á¾á€á˜á¸á€áŸ’ášá¼á áŸ’áœá¼á“á”á¶á“á‘áŸáŸ”"); } };
            const stopRecording = () => { if (mediaRecorder) { mediaRecorder.stop(); setIsRecording(false); setMediaRecorder(null); } };
            const sendMessageWithMedia = async (url, type) => { if (!activeChat) return; const db = dbRef.current; const timestamp = Date.now(); const msgText = type === 'image' ? 'ğŸ“· ášá¼á”á—á¶á–' : type === 'video' ? 'ğŸ¥ áœá¸áŠáŸá¢á¼' : 'ğŸ¤ áŸáŸ†á¡áŸá„'; const msgData = { text: msgText, fileUrl: url, type: type, senderId: currentUser.uid, senderName: currentUser.username, createdAt: timestamp }; await window.fb.push(window.fb.ref(db, `messages/${activeChat.id}`), msgData); if (activeChat.type === 'direct') { await window.fb.update(window.fb.ref(db, `user_chats/${currentUser.uid}/${activeChat.partnerId}`), { lastMsg: msgText, timestamp }); await window.fb.update(window.fb.ref(db, `user_chats/${activeChat.partnerId}/${currentUser.uid}`), { lastMsg: msgText, timestamp }); } else { await window.fb.update(window.fb.ref(db, `groups/${activeChat.id}`), { lastMsg: msgText, timestamp }); } };
            const handleSendMessage = async (e) => { e.preventDefault(); if (!inputText.trim() || !activeChat) return; const text = inputText; setInputText(''); const db = dbRef.current; const timestamp = Date.now(); try { if (editingMessageId) { await window.fb.update(window.fb.ref(db, `messages/${activeChat.id}/${editingMessageId}`), { text: text, updatedAt: timestamp }); setEditingMessageId(null); } else { await window.fb.push(window.fb.ref(db, `messages/${activeChat.id}`), { 
                            text: text, type: 'text', senderId: currentUser.uid, senderName: currentUser.username, createdAt: timestamp 
                        });
                        if (activeChat.type === 'direct') {
                            await window.fb.update(window.fb.ref(db, `user_chats/${currentUser.uid}/${activeChat.partnerId}`), { name: activeChat.name, tag: activeChat.tag, uid: activeChat.partnerId, lastMsg: text, timestamp });
                            await window.fb.update(window.fb.ref(db, `user_chats/${activeChat.partnerId}/${currentUser.uid}`), { name: currentUser.username, tag: currentUser.tag, uid: currentUser.uid, lastMsg: text, timestamp });
                        } else if (activeChat.type === 'group') {
                            await window.fb.update(window.fb.ref(db, `groups/${activeChat.id}`), { lastMsg: text, timestamp });
                        }
                    }
                } catch (e) { setInputText(text); }
            };

            const handleRegister = async (name) => { if (!name.trim()) return; const db = dbRef.current; const newUid = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5); const cleanName = name.replace(/\s+/g, '').substring(0, 10); const randomSuffix = Math.floor(100 + Math.random() * 900); const newUsername = `@${cleanName}_${randomSuffix}`; const userData = { username: name, tag: newUsername, deviceId: deviceIdRef.current, createdAt: Date.now() }; try { await window.fb.set(window.fb.ref(db, `users/${newUid}`), userData); await window.fb.set(window.fb.ref(db, `usernames/${newUsername}`), newUid); localStorage.setItem('chat_app_uid', newUid); setCurrentUser({ uid: newUid, ...userData }); setView('home'); } catch (e) { alert("á”ášá¶á‡áŸá™á€áŸ’á“á»á„á€á¶ášá”á„áŸ’á€á¾áá‚áá“á¸áŸ”"); } };
            const handleLogin = async (name, tag, password) => { const db = dbRef.current; try { const snapshot = await window.fb.get(window.fb.ref(db, `usernames/${tag.trim()}`)); if (!snapshot.exists()) { alert("ášá€á˜á·á“áƒá¾á‰ Username á“áŸáŸ‡á‘áŸáŸ”"); return; } const uid = snapshot.val(); const userSnap = await window.fb.get(window.fb.ref(db, `users/${uid}`)); if (!userSnap.exists()) return; const userData = userSnap.val(); if (userData.username !== name.trim()) { alert("áˆáŸ’á˜áŸ„áŸ‡á˜á·á“ááŸ’ášá¹á˜ááŸ’ášá¼áœáŸ”"); return; } if (userData.deviceId === deviceIdRef.current) { localStorage.setItem('chat_app_uid', uid); setCurrentUser({ uid, ...userData }); setView('home'); } else { if (userData.password) { if (userData.password === password) { localStorage.setItem('chat_app_uid', uid); setCurrentUser({ uid, ...userData }); setView('home'); } else { alert("Password á˜á·á“ááŸ’ášá¹á˜ááŸ’ášá¼áœáŸ”"); } } else { await window.fb.update(window.fb.ref(db, `users/${uid}`), { deviceId: deviceIdRef.current }); localStorage.setItem('chat_app_uid', uid); setCurrentUser({ uid, ...userData, deviceId: deviceIdRef.current }); setView('home'); } } } catch (e) { alert("á˜á¶á“á”á‰áŸ’á á¶áŸ”"); } };
            const savePasswordAndLogout = async () => { if (!newPassword.trim()) return; try { await window.fb.update(window.fb.ref(dbRef.current, `users/${currentUser.uid}`), { password: newPassword }); setShowPasswordModal(false); performLogout(); } catch (e) { alert("á”ášá¶á‡áŸá™áŸ”"); } };
            const performLogout = () => { localStorage.removeItem('chat_app_uid'); setCurrentUser(null); setActiveChat(null); setMessages([]); setView('login'); };
            const handleCreateGroup = async () => { if (!groupName.trim()) return; const db = dbRef.current; const groupId = 'group_' + Date.now() + Math.random().toString(36).substr(2, 5); const inviteCode = Math.random().toString(36).substr(2, 8).toUpperCase(); const timestamp = Date.now(); const groupData = { name: groupName, owner: currentUser.uid, inviteCode: inviteCode, createdAt: timestamp, members: { [currentUser.uid]: true }, settings: { viewMembers: true, addMembers: true }, lastMsg: "Group Created", timestamp: timestamp }; try { await window.fb.set(window.fb.ref(db, `groups/${groupId}`), groupData); await window.fb.set(window.fb.ref(db, `user_groups/${currentUser.uid}/${groupId}`), true); await window.fb.set(window.fb.ref(db, `group_invites/${inviteCode}`), groupId); setGroupName(''); setShowGroupModal(false); alert(`á”á¶á“á”á„áŸ’á€á¾áá€áŸ’ášá»á˜á‡áŸ„á‚á‡áŸá™! á›áŸáá€á¼áŠá€áŸ’ášá»á˜áŸ– ${inviteCode}`); } catch (e) { alert("á”ášá¶á‡áŸá™áŸ”"); } };
            const handleJoinGroup = async () => { if (!groupJoinCode.trim()) return; const db = dbRef.current; try { const codeSnap = await window.fb.get(window.fb.ref(db, `group_invites/${groupJoinCode.trim()}`)); if (!codeSnap.exists()) { alert("á›áŸáá€á¼áŠá˜á·á“ááŸ’ášá¹á˜ááŸ’ášá¼áœáŸ”"); return; } const groupId = codeSnap.val(); const blockedSnap = await window.fb.get(window.fb.ref(db, `groups/${groupId}/blocked/${currentUser.uid}`)); if (blockedSnap.exists()) { alert("á¢áŸ’á“á€ááŸ’ášá¼áœá”á¶á“á”á·á‘ (Block) á–á¸á€áŸ’ášá»á˜á“áŸáŸ‡áŸ”"); return; } await window.fb.set(window.fb.ref(db, `groups/${groupId}/members/${currentUser.uid}`), true); await window.fb.set(window.fb.ref(db, `user_groups/${currentUser.uid}/${groupId}`), true); setGroupJoinCode(''); setShowGroupModal(false); alert("á…á¼á›á€áŸ’ášá»á˜á”á¶á“á‡áŸ„á‚á‡áŸá™!"); } catch (e) { alert("á˜á¶á“á”á‰áŸ’á á¶áŸ”"); } };
            const handleDeleteChatAction = async (chat, e) => { e.stopPropagation(); const db = dbRef.current; if (chat.type === 'direct') { if (!window.confirm("áá¾á¢áŸ’á“á€á…á„áŸ‹á›á»á”á€á¶ášáŸá“áŸ’á‘á“á¶á“áŸáŸ‡á…áŸá‰á–á¸á”á‰áŸ’á‡á¸á˜áŸ‚á“á‘áŸ?")) return; try { await window.fb.remove(window.fb.ref(db, `user_chats/${currentUser.uid}/${chat.id}`)); } catch (e) {} } else if (chat.type === 'group') { if (chat.owner === currentUser.uid) { if (!window.confirm("áá¾á¢áŸ’á“á€á–á·áá‡á¶á…á„áŸ‹á›á»á”á€áŸ’ášá»á˜á“áŸáŸ‡á˜áŸ‚á“á‘áŸ?")) return; try { await window.fb.remove(window.fb.ref(db, `groups/${chat.id}`)); await window.fb.remove(window.fb.ref(db, `messages/${chat.id}`)); if(chat.inviteCode) await window.fb.remove(window.fb.ref(db, `group_invites/${chat.inviteCode}`)); } catch (e) { alert("á˜á¶á“á”á‰áŸ’á á¶áŸ”"); } } else { if (!window.confirm("áá¾á¢áŸ’á“á€á…á„áŸ‹á…á¶á€á…áŸá‰á–á¸á€áŸ’ášá»á˜á“áŸáŸ‡á˜áŸ‚á“á‘áŸ?")) return; try { await window.fb.remove(window.fb.ref(db, `groups/${chat.id}/members/${currentUser.uid}`)); await window.fb.remove(window.fb.ref(db, `user_groups/${currentUser.uid}/${chat.id}`)); } catch (e) { alert("á˜á¶á“á”á‰áŸ’á á¶áŸ”"); } } } };
            const startChat = (partner) => { const uids = [currentUser.uid, partner.uid].sort(); const chatId = `${uids[0]}_${uids[1]}`; setActiveChat({ id: chatId, type: 'direct', name: partner.username, tag: partner.tag, partnerId: partner.uid }); setView('chat'); setSearchResult(null); setSearchQuery(''); };
            const startGroupChat = (group) => { setActiveChat({ id: group.id, type: 'group', name: group.name, owner: group.owner, inviteCode: group.inviteCode }); setView('chat'); };
            const handleDeleteMessage = async (msgId) => { if(window.confirm("á›á»á”áŸá¶ášá“áŸáŸ‡?")) { const db = dbRef.current; await window.fb.remove(window.fb.ref(db, `messages/${activeChat.id}/${msgId}`)); if(editingMessageId === msgId) { setEditingMessageId(null); setInputText(''); } setMobileDeleteId(null); } };
            const handleEditMessage = (msg) => { if (msg.type !== 'text') return; setEditingMessageId(msg.id); setInputText(msg.text); setMobileDeleteId(null); setTimeout(() => inputRef.current?.focus(), 100); };
            const handleTouchStart = (msgId) => { longPressTimerRef.current = setTimeout(() => { setMobileDeleteId(msgId); longPressTimerRef.current = null; }, 500); };
            const handleTouchEnd = (msg) => { if (longPressTimerRef.current) { clearTimeout(longPressTimerRef.current); longPressTimerRef.current = null; if (mobileDeleteId !== msg.id) { if (msg.senderId !== currentUser.uid) { setActiveReactionId(prev => prev === msg.id ? null : msg.id); } else { handleEditMessage(msg); } } else { setMobileDeleteId(null); } } };
            const handleClick = (msg) => { if (window.matchMedia("(hover: hover)").matches) { if (msg.senderId === currentUser.uid) { handleEditMessage(msg); } } };
            const handleContextMenu = (e, msg) => { if (msg.senderId !== currentUser.uid) { e.preventDefault(); setActiveReactionId(prev => prev === msg.id ? null : msg.id); } };
            const handleAddReaction = async (msgId, emoji) => { const db = dbRef.current; const reactionRef = window.fb.ref(db, `messages/${activeChat.id}/${msgId}/reactions/${currentUser.uid}`); const snapshot = await window.fb.get(reactionRef); if (snapshot.exists() && snapshot.val() === emoji) { await window.fb.remove(reactionRef); } else { await window.fb.set(reactionRef, emoji); } setActiveReactionId(null); };
            const handleShowSeenBy = async (seenUids) => { const db = dbRef.current; const users = []; for (const uid of seenUids) { try { const snap = await window.fb.get(window.fb.ref(db, `users/${uid}`)); if(snap.exists()) { users.push({ uid, ...snap.val() }); } } catch(e) { console.error(e); } } setSeenByUsers(users); setShowSeenByModal(true); };
            const getSeenInfo = (msg) => { if (!msg.seenBy) return null; const seenUids = Object.keys(msg.seenBy).filter(uid => uid !== currentUser.uid); if (seenUids.length === 0) return null; if (activeChat.type === 'direct') return seenUids.includes(activeChat.partnerId) ? <CheckDoubleIcon className="w-4 h-4 text-blue-500" /> : null; else return (<div className="flex items-center gap-1 text-xs text-gray-400 cursor-pointer hover:text-blue-500" onClick={(e) => { e.stopPropagation(); handleShowSeenBy(seenUids); }}><EyeIcon className="w-3 h-3"/> {seenUids.length}</div>); };
            const handleSearch = async (e) => { e.preventDefault(); setSearchResult(null); setSearchError(''); if (!searchQuery.startsWith('@')) { setSearchError("áˆáŸ’á˜áŸ„áŸ‡áŸá˜áŸ’á‚á¶á›áŸ‹ááŸ’ášá¼áœá…á¶á”áŸ‹á•áŸ’áá¾á˜áŠáŸ„á™ @"); return; } const db = dbRef.current; try { const snapshot = await window.fb.get(window.fb.ref(db, `usernames/${searchQuery.trim()}`)); if (snapshot.exists()) { const partnerUid = snapshot.val(); if (partnerUid === currentUser.uid) { setSearchError("á“áŸáŸ‡á‡á¶á‚áá“á¸ášá”áŸáŸ‹á¢áŸ’á“á€!"); return; } const partnerSnapshot = await window.fb.get(window.fb.ref(db, `users/${partnerUid}`)); if (partnerSnapshot.exists()) setSearchResult({ uid: partnerUid, ...partnerSnapshot.val() }); } else { setSearchError("ášá€á˜á·á“áƒá¾á‰á¢áŸ’á“á€á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹á“áŸáŸ‡á‘áŸáŸ”"); } } catch (e) { setSearchError("á˜á¶á“á”á‰áŸ’á á¶áŸ”"); } };
            const copyToClipboard = (text) => { const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; textArea.style.left = "-9999px"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { document.execCommand('copy'); alert("á”á¶á“á…á˜áŸ’á›á„: " + text); } catch (err) {} document.body.removeChild(textArea); };
            const toggleGroupSetting = async (key) => { const oldSettings = allGroupsData[activeChat.id]?.settings || { viewMembers: true, addMembers: true }; const newSettings = { ...oldSettings, [key]: !oldSettings[key] }; setAllGroupsData(prev => ({ ...prev, [activeChat.id]: { ...prev[activeChat.id], settings: newSettings } })); try { await window.fb.update(window.fb.ref(dbRef.current, `groups/${activeChat.id}/settings`), { [key]: newSettings[key] }); } catch (e) { console.error(e); } };
            const fetchGroupSettings = async () => { if (!activeChat || activeChat.type !== 'group') return; const db = dbRef.current; const membersSnap = await window.fb.get(window.fb.ref(db, `groups/${activeChat.id}/members`)); const blockedSnap = await window.fb.get(window.fb.ref(db, `groups/${activeChat.id}/blocked`)); const membersList = []; if (membersSnap.exists()) { for (const mid of Object.keys(membersSnap.val())) { const userSnap = await window.fb.get(window.fb.ref(db, `users/${mid}`)); if (userSnap.exists()) membersList.push({ uid: mid, ...userSnap.val() }); } } const blockedList = []; if (blockedSnap.exists()) { for (const bid of Object.keys(blockedSnap.val())) { const userSnap = await window.fb.get(window.fb.ref(db, `users/${bid}`)); if (userSnap.exists()) blockedList.push({ uid: bid, ...userSnap.val() }); } } setGroupMembers(membersList); setGroupBlocked(blockedList); setShowSettingsModal(true); };
            const handleAddMember = async () => { if (!addMemberQuery.trim()) return; const db = dbRef.current; try { const snap = await window.fb.get(window.fb.ref(db, `usernames/${addMemberQuery.trim()}`)); if (!snap.exists()) { alert("ášá€á˜á·á“áƒá¾á‰ Username á“áŸáŸ‡á‘áŸáŸ”"); return; } const uidToAdd = snap.val(); const blockedSnap = await window.fb.get(window.fb.ref(db, `groups/${activeChat.id}/blocked/${uidToAdd}`)); if (blockedSnap.exists()) { alert("á¢áŸ’á“á€á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹á“áŸáŸ‡á€áŸ†á–á»á„á‡á¶á”áŸ‹ BlockáŸ”"); return; } await window.fb.set(window.fb.ref(db, `groups/${activeChat.id}/members/${uidToAdd}`), true); await window.fb.set(window.fb.ref(db, `user_groups/${uidToAdd}/${activeChat.id}`), true); setAddMemberQuery(''); fetchGroupSettings(); alert("á”á¶á“á”á“áŸ’ááŸ‚á˜áŸá˜á¶á‡á·á€áŸ”"); } catch (e) { alert("á˜á¶á“á”á‰áŸ’á á¶áŸ”"); } };
            const handleRemoveMember = async (memberId) => { if (!window.confirm("áŠá€áŸá˜á¶á‡á·á€?")) return; const db = dbRef.current; try { await window.fb.remove(window.fb.ref(db, `groups/${activeChat.id}/members/${memberId}`)); await window.fb.remove(window.fb.ref(db, `user_groups/${memberId}/${activeChat.id}`)); await window.fb.set(window.fb.ref(db, `groups/${activeChat.id}/blocked/${memberId}`), true); fetchGroupSettings(); } catch (e) {} };
            const handleUnblockMember = async (memberId) => { const db = dbRef.current; try { await window.fb.remove(window.fb.ref(db, `groups/${activeChat.id}/blocked/${memberId}`)); fetchGroupSettings(); } catch (e) {} };
            const handleMemberClick = (member) => { if (member.uid === currentUser.uid) return; startChat({ uid: member.uid, username: member.username, tag: member.tag }); setShowSettingsModal(false); };
            useEffect(() => { if (view !== 'chat' || !activeChat || !firebaseReady) return; const db = dbRef.current; const messagesRef = window.fb.ref(db, `messages/${activeChat.id}`); const unsubscribe = window.fb.onValue(messagesRef, (snapshot) => { const data = snapshot.val(); const msgs = []; if (data) { Object.keys(data).forEach(key => { const msg = { id: key, ...data[key] }; if (msg.senderId !== currentUser.uid) { if (!msg.seenBy || !msg.seenBy[currentUser.uid]) { window.fb.update(window.fb.ref(db, `messages/${activeChat.id}/${key}/seenBy`), { [currentUser.uid]: true }); } } msgs.push(msg); }); } msgs.sort((a, b) => a.createdAt - b.createdAt); setMessages(msgs); }); return () => unsubscribe(); }, [view, activeChat, firebaseReady]);
            useEffect(() => { if(view === 'chat') messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages, view, uploadingItem]);

            // --- Call Logic Functions ---
            const initiateCall = async (type) => {
                if (!activeChat) return;
                const db = dbRef.current;
                const callId = 'call_' + Date.now() + Math.random().toString(36).substr(2, 5);
                
                const callData = {
                    id: callId,
                    caller: {
                        uid: currentUser.uid,
                        name: currentUser.username,
                        photoUrl: currentUser.photoUrl || ''
                    },
                    target: {
                        id: activeChat.id, // Group ID or User ID if direct (using chat ID for simplicity)
                        name: activeChat.name,
                        type: activeChat.type // 'direct' or 'group'
                    },
                    type: type, // 'audio' or 'video'
                    status: 'ringing',
                    participants: {
                        [currentUser.uid]: true
                    },
                    timestamp: Date.now()
                };

                try {
                    await window.fb.set(window.fb.ref(db, `active_calls/${callId}`), callData);
                    setActiveCallSession(callData);
                    // Also push a message about the call
                    const msgData = {
                        text: type === 'video' ? 'ğŸ“ Video Call Started' : 'ğŸ“ Audio Call Started',
                        type: 'call_log',
                        senderId: currentUser.uid,
                        senderName: currentUser.username,
                        createdAt: Date.now()
                    };
                    await window.fb.push(window.fb.ref(db, `messages/${activeChat.id}`), msgData);
                } catch (e) {
                    console.error("Call init failed", e);
                }
            };

            const acceptCall = async (call) => {
                const db = dbRef.current;
                try {
                    const updates = {};
                    updates[`active_calls/${call.id}/status`] = 'active';
                    updates[`active_calls/${call.id}/participants/${currentUser.uid}`] = true;
                    await window.fb.update(window.fb.ref(db), updates);
                    
                    setActiveCallSession(call);
                    setIncomingCall(null);
                } catch (e) { console.error("Accept failed", e); }
            };

            const rejectCall = () => {
                // Just hide locally for now
                setIncomingCall(null);
            };

            const endCall = async () => {
                if (!activeCallSession) return;
                const db = dbRef.current;
                const callId = activeCallSession.id;
                
                try {
                    // Remove self
                    await window.fb.remove(window.fb.ref(db, `active_calls/${callId}/participants/${currentUser.uid}`));
                    
                    // If I was the caller or last participant, remove call completely (simplified logic)
                    // In a real app, check participant count
                    const callSnap = await window.fb.get(window.fb.ref(db, `active_calls/${callId}/participants`));
                    if (!callSnap.exists() || Object.keys(callSnap.val()).length === 0) {
                         await window.fb.remove(window.fb.ref(db, `active_calls/${callId}`));
                    }

                    setActiveCallSession(null);
                } catch (e) { console.error("End call failed", e); }
            };

            // --- Views ---
            if (view === 'loading') return (<div className="flex items-center justify-center h-full"><Loader2Icon className="animate-spin text-blue-500 w-10 h-10" /></div>);
            if (view === 'login') return <LoginView onRegister={handleRegister} onLogin={handleLogin} />;

            if (view === 'home') {
                return (
                    <div className="flex flex-col h-full bg-gray-50 max-w-md mx-auto shadow-2xl overflow-hidden relative">
                        {incomingCall && (
                            <IncomingCallModal 
                                call={incomingCall} 
                                onAnswer={() => acceptCall(incomingCall)} 
                                onDecline={rejectCall} 
                            />
                        )}
                        {activeCallSession && (
                            <ActiveCallModal 
                                call={activeCallSession} 
                                currentUser={currentUser}
                                onEndCall={endCall}
                            />
                        )}

                        {showProfileModal && (
                            <div className="absolute inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
                                <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-xl modal-content flex flex-col items-center">
                                    <h3 className="font-bold text-lg mb-4 text-gray-800">á€á¶ášá€áŸ†áááŸ‹á‚áá“á¸</h3>
                                    <div className="relative mb-4 group cursor-pointer" onClick={() => profileImageInputRef.current.click()}>
                                        <div className="w-24 h-24 rounded-full overflow-hidden border-4 border-white shadow-lg bg-gray-200">
                                            {currentUser.photoUrl ? <img src={currentUser.photoUrl} className="w-full h-full object-cover" /> : <UserIcon className="w-full h-full text-gray-400 p-2"/>}
                                        </div>
                                        <div className="absolute inset-0 bg-black/30 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><Edit2Icon className="w-8 h-8 text-white" /></div>
                                        {isUploadingProfile && <div className="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center"><Loader2Icon className="w-8 h-8 text-white animate-spin"/></div>}
                                    </div>
                                    <input type="file" ref={profileImageInputRef} className="hidden" accept="image/*" onChange={handleProfilePhotoUpload} />
                                    <h2 className="font-bold text-xl">{currentUser.username}</h2>
                                    <p className="text-sm text-gray-500 mb-6">{currentUser.tag}</p>
                                    <div className="w-full mb-2">
                                        <p className="text-xs font-bold text-gray-500 mb-1 uppercase">áŸá»áœááŸ’áá·á—á¶á–</p>
                                        <input type="password" placeholder="Password ááŸ’á˜á¸..." className="w-full px-4 py-3 rounded-xl border mb-2 focus:ring-2 focus:ring-blue-500 outline-none" value={newPassword} onChange={(e) => setNewPassword(e.target.value)}/>
                                        <button onClick={handleChangePassword} className="w-full py-2 bg-blue-600 text-white rounded-lg font-bold text-sm hover:bg-blue-700">á”áŸ’áŠá¼áš Password</button>
                                    </div>
                                    <button onClick={() => setShowProfileModal(false)} className="mt-4 text-gray-500 hover:text-gray-700">á”á·á‘</button>
                                </div>
                            </div>
                        )}
                        {showPasswordModal && (<div className="absolute inset-0 z-50 bg-black/50 flex items-center justify-center p-4"><div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-xl modal-content"><h3 className="font-bold text-lg text-center mb-4">á”á„áŸ’á€á¾á Password áŠá¾á˜áŸ’á”á¸ Logout</h3><input type="password" placeholder="Password ááŸ’á˜á¸..." className="w-full px-4 py-3 rounded-xl border mb-4" value={newPassword} onChange={(e) => setNewPassword(e.target.value)}/><div className="flex gap-2"><button onClick={() => setShowPasswordModal(false)} className="flex-1 py-2 bg-gray-200 rounded-lg">á”áŸ„áŸ‡á”á„áŸ‹</button><button onClick={savePasswordAndLogout} className="flex-1 py-2 bg-blue-600 text-white rounded-lg">ášá€áŸ’áŸá¶á‘á»á€ & Logout</button></div></div></div>)}
                        {showGroupModal && (<div className="absolute inset-0 z-50 bg-black/50 flex items-center justify-center p-4"><div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-xl modal-content"><div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg">á”á„áŸ’á€á¾á á¬ á…á¼á›á€áŸ’ášá»á˜</h3><button onClick={() => setShowGroupModal(false)}><XIcon className="w-6 h-6 text-gray-500"/></button></div><div className="mb-6"><p className="text-sm font-bold text-blue-600 mb-2">á”á„áŸ’á€á¾áá€áŸ’ášá»á˜ááŸ’á˜á¸</p><div className="flex gap-2"><input type="text" placeholder="áˆáŸ’á˜áŸ„áŸ‡á€áŸ’ášá»á˜..." className="flex-1 px-3 py-2 border rounded-lg" value={groupName} onChange={(e)=>setGroupName(e.target.value)}/><button onClick={handleCreateGroup} className="bg-blue-600 text-white px-4 rounded-lg text-sm">á”á„áŸ’á€á¾á</button></div></div><div className="border-t pt-4"><p className="text-sm font-bold text-green-600 mb-2">á…á¼á›á€áŸ’ášá»á˜ (Join)</p><div className="flex gap-2"><input type="text" placeholder="á›áŸáá€á¼áŠá€áŸ’ášá»á˜..." className="flex-1 px-3 py-2 border rounded-lg" value={groupJoinCode} onChange={(e)=>setGroupJoinCode(e.target.value)}/><button onClick={handleJoinGroup} className="bg-green-600 text-white px-4 rounded-lg text-sm">á…á¼á›</button></div></div></div></div>)}

                        <div className="bg-blue-600 p-4 text-white rounded-b-3xl shadow-md z-10">
                            <div className="flex justify-between items-start mb-4">
                                <h1 className="text-2xl font-bold">á€á˜áŸ’á˜áœá·á’á¸á‡á‡áŸ‚á€á€á˜áŸ’áŸá¶á“áŸ’á</h1>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowProfileModal(true)}><SettingsIcon className="w-6 h-6" /></button>
                                    <button onClick={() => (!currentUser.password ? setShowPasswordModal(true) : performLogout())}><LogoutIcon className="w-6 h-6" /></button>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className="w-12 h-12 bg-white/20 rounded-full overflow-hidden flex-shrink-0">{currentUser.photoUrl ? <img src={currentUser.photoUrl} className="w-full h-full object-cover"/> : <UserIcon className="w-full h-full p-2"/>}</div>
                                <div><div className="font-bold text-lg">{currentUser.username}</div><span className="font-mono bg-blue-800/50 px-2 py-0.5 rounded text-xs cursor-pointer" onClick={() => copyToClipboard(currentUser.tag)}>{currentUser.tag}</span></div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto px-4 pt-4 pb-4">
                            <form onSubmit={handleSearch} className="flex gap-2 mb-4"><input type="text" placeholder="áŸáŸ’áœáŸ‚á„ášá€ @username..." className="flex-1 px-4 py-3 rounded-xl border focus:ring-2 focus:ring-blue-500 outline-none" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)}/><button type="submit" className="bg-blue-600 text-white p-3 rounded-xl shadow-md"><SearchIcon className="w-6 h-6" /></button></form>
                            <button onClick={() => setShowGroupModal(true)} className="w-full py-3 mb-4 border-2 border-dashed border-blue-300 text-blue-500 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-blue-50">+ á”á„áŸ’á€á¾á á¬ á…á¼á›á€áŸ’ášá»á˜ááŸ’á˜á¸</button>
                            {searchError && <p className="text-red-500 text-sm bg-red-50 p-2 rounded text-center mb-2">{searchError}</p>}
                            {searchResult && (<div className="bg-white p-4 rounded-xl shadow flex items-center justify-between mb-4 border-2 border-blue-100"><div className="flex items-center gap-3"><div className="w-10 h-10 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white font-bold overflow-hidden">{searchResult.photoUrl ? <img src={searchResult.photoUrl} className="w-full h-full object-cover"/> : searchResult.username[0]}</div><div><p className="font-bold text-gray-800">{searchResult.username}</p><p className="text-xs text-gray-500">{searchResult.tag}</p></div></div><button onClick={() => startChat(searchResult)} className="bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-green-600">á‡á‡áŸ‚á€</button></div>)}
                            <div className="space-y-2">
                                {allChats.length > 0 && !searchQuery && <p className="text-xs font-bold text-gray-400 mb-2 uppercase">á€á¶ášáŸá“áŸ’á‘á“á¶ááŸ’á˜á¸áŸ—</p>}
                                {allChats.map(chat => (
                                    <div key={chat.id} onClick={() => chat.type === 'direct' ? startChat({uid: chat.id, username: chat.name, tag: chat.tag}) : startGroupChat(chat)} className="bg-white p-3 rounded-xl shadow-sm flex items-center gap-3 cursor-pointer hover:bg-gray-50 transition group relative">
                                        <div className={`w-12 h-12 flex-shrink-0 rounded-full flex items-center justify-center text-white font-bold overflow-hidden ${chat.type === 'group' ? 'bg-indigo-500' : 'bg-gray-400'}`}>
                                            {chat.type === 'group' ? <UsersIcon className="w-6 h-6"/> : (chat.photoUrl ? <img src={chat.photoUrl} className="w-full h-full object-cover"/> : chat.name[0])}
                                        </div>
                                        <div className="flex-1 overflow-hidden"><div className="flex justify-between items-center"><p className="font-bold text-gray-800 truncate">{chat.name}</p>{chat.timestamp && <span className="text-[10px] text-gray-400">{new Date(chat.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>}</div><p className="text-xs text-gray-500 truncate">{chat.lastMsg || 'á‚áŸ’á˜á¶á“áŸá¶áš'}</p></div>
                                        <button onClick={(e) => handleDeleteChatAction(chat, e)} className="p-3 text-gray-300 hover:text-red-500 transition flex-shrink-0">{chat.type === 'group' && chat.owner !== currentUser.uid ? <LeaveIcon className="w-5 h-5" /> : <TrashIcon className="w-5 h-5" />}</button>
                                    </div>
                                ))}
                                {allChats.length === 0 && !searchResult && <div className="text-center text-gray-400 mt-8"><p>á˜á·á“á‘á¶á“áŸ‹á˜á¶á“á€á¶ášáŸá“áŸ’á‘á“á¶á‘áŸáŸ”</p></div>}
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'chat') {
                const isOwner = activeChat.type === 'group' && activeChat.owner === currentUser.uid;
                const currentGroupSettings = activeChat.type === 'group' 
                    ? (allGroupsData[activeChat.id]?.settings || { viewMembers: true, addMembers: true }) 
                    : null;

                return (
                    <div className="flex flex-col h-full bg-gray-100 font-battambang max-w-md mx-auto shadow-2xl relative">
                        <input type="file" accept="image/*" className="hidden" ref={imageInputRef} onChange={(e) => handleFileUpload(e, 'image')} />
                        <input type="file" accept="video/*" className="hidden" ref={videoInputRef} onChange={(e) => handleFileUpload(e, 'video')} />

                        {showCallModal && (
                            <div className="absolute inset-0 z-50 bg-gray-900 flex flex-col items-center justify-center text-white">
                                <div className="w-32 h-32 rounded-full bg-gray-700 flex items-center justify-center mb-8 ripple-effect relative"><div className="w-24 h-24 rounded-full overflow-hidden bg-gray-500 z-10"><UserIcon className="w-full h-full p-4"/></div></div>
                                <h2 className="text-2xl font-bold mb-2">{activeChat.name}</h2>
                                <p className="text-gray-400 mb-12 animate-pulse">{showCallModal === 'audio' ? 'á€áŸ†á–á»á„á áŸ…áŸáŸ†á¡áŸá„...' : 'á€áŸ†á–á»á„á áŸ…áœá¸áŠáŸá¢á¼...'}</p>
                                <button onClick={() => setShowCallModal(null)} className="p-4 bg-red-600 rounded-full hover:bg-red-700 shadow-lg transform transition active:scale-95"><PhoneOffIcon className="w-8 h-8" /></button>
                            </div>
                        )}

                        {showSettingsModal && (<div className="absolute inset-0 z-50 bg-black/50 flex items-center justify-center p-4"><div className="bg-white p-4 rounded-2xl w-full max-w-sm shadow-xl modal-content h-[80vh] flex flex-col"><div className="flex justify-between items-center mb-4 border-b pb-2"><h3 className="font-bold text-lg">á€á¶ášá€áŸ†áááŸ‹á€áŸ’ášá»á˜: {activeChat.name}</h3><button onClick={() => setShowSettingsModal(false)}><XIcon className="w-6 h-6 text-gray-500"/></button></div><div className="mb-4 bg-blue-50 p-3 rounded-lg"><p className="text-xs text-gray-500 uppercase">á›áŸáá€á¼áŠá€áŸ’ášá»á˜</p><div className="flex justify-between items-center font-mono font-bold text-blue-700">{activeChat.inviteCode}<button onClick={() => copyToClipboard(activeChat.inviteCode)}><CopyIcon className="w-4 h-4"/></button></div></div>
                        
                        {isOwner && (
                            <div className="mb-4 p-3 bg-gray-50 rounded-lg border">
                                <p className="text-sm font-bold mb-2 text-gray-700">á€á¶ášá€áŸ†áááŸ‹áŸá·á‘áŸ’á’á· (Owner Only)</p>
                                <div className="flex items-center justify-between mb-2">
                                    <span className="text-sm">á¢á“á»á‰áŸ’á‰á¶áá±áŸ’á™á˜á¾á›áŸá˜á¶á‡á·á€</span>
                                    <div className="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" name="toggle" id="viewMembersToggle" className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked={currentGroupSettings.viewMembers} onChange={() => toggleGroupSetting('viewMembers')}/>
                                        <label htmlFor="viewMembersToggle" className={`toggle-label block overflow-hidden h-6 rounded-full cursor-pointer ${currentGroupSettings.viewMembers ? 'bg-green-400' : 'bg-gray-300'}`}></label>
                                    </div>
                                </div>
                                <div className="flex items-center justify-between">
                                    <span className="text-sm">á¢á“á»á‰áŸ’á‰á¶áá±áŸ’á™á”á“áŸ’ááŸ‚á˜áŸá˜á¶á‡á·á€</span>
                                    <div className="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" name="toggle" id="addMembersToggle" className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked={currentGroupSettings.addMembers} onChange={() => toggleGroupSetting('addMembers')}/>
                                        <label htmlFor="addMembersToggle" className={`toggle-label block overflow-hidden h-6 rounded-full cursor-pointer ${currentGroupSettings.addMembers ? 'bg-green-400' : 'bg-gray-300'}`}></label>
                                    </div>
                                </div>
                            </div>
                        )}

                        {(isOwner || currentGroupSettings?.addMembers) && (
                            <div className="mb-4"><p className="text-sm font-bold mb-2">á”á“áŸ’ááŸ‚á˜áŸá˜á¶á‡á·á€</p><div className="flex gap-2"><input type="text" placeholder="@username..." className="flex-1 px-3 py-2 border rounded-lg" value={addMemberQuery} onChange={(e)=>setAddMemberQuery(e.target.value)}/><button onClick={handleAddMember} className="bg-blue-600 text-white px-3 rounded-lg text-sm">á”á“áŸ’ááŸ‚á˜</button></div></div>
                        )}
                        
                        <div className="flex-1 overflow-y-auto mb-4">
                            <p className="text-sm font-bold mb-2">áŸá˜á¶á‡á·á€ ({groupMembers.length})</p>
                            {(isOwner || currentGroupSettings?.viewMembers) ? (
                                <div className="space-y-2 mb-4">
                                    {groupMembers.map(m => (
                                        <div key={m.uid} onClick={() => handleMemberClick(m)} className="flex justify-between items-center bg-gray-50 p-2 rounded cursor-pointer hover:bg-gray-100">
                                            <span className="text-sm flex items-center gap-2">
                                                <div className="w-6 h-6 rounded-full overflow-hidden bg-gray-200">{m.photoUrl ? <img src={m.photoUrl} className="w-full h-full object-cover"/> : <UserIcon className="w-full h-full p-1"/>}</div>
                                                {m.username} 
                                                <span className="text-xs text-gray-400">{m.tag}</span>
                                                {m.uid !== currentUser.uid && <span className="text-[10px] bg-blue-100 text-blue-600 px-1 rounded">Chat</span>}
                                            </span>
                                            {isOwner && m.uid !== currentUser.uid && (<button onClick={(e) => { e.stopPropagation(); handleRemoveMember(m.uid); }} className="text-red-500 bg-red-100 p-1 rounded"><UserMinusIcon className="w-4 h-4"/></button>)}
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <p className="text-xs text-gray-500 italic">á”á‰áŸ’á‡á¸áŸá˜á¶á‡á·á€ááŸ’ášá¼áœá”á¶á“á›á¶á€áŸ‹áŠáŸ„á™á˜áŸ’á…á¶áŸáŸ‹á€áŸ’ášá»á˜áŸ”</p>
                            )}
                            
                            {isOwner && groupBlocked.length > 0 && (<div><p className="text-sm font-bold mb-2 text-red-600">á¢áŸ’á“á€áŠáŸ‚á›ááŸ’ášá¼áœá”á¶á“ Block</p><div className="space-y-2">{groupBlocked.map(b => (<div key={b.uid} className="flex justify-between items-center bg-red-50 p-2 rounded border border-red-100"><span className="text-sm text-gray-600">{b.username}</span><button onClick={() => handleUnblockMember(b.uid)} className="text-green-600 text-xs font-bold">Unblock</button></div>))}</div></div>)}
                        </div>
                        {isOwner && (<div className="pt-2 border-t"><button onClick={() => handleDeleteChatAction(activeChat, {stopPropagation:()=>{}})} className="w-full py-3 bg-red-50 text-red-600 font-bold rounded-lg hover:bg-red-100 transition flex items-center justify-center gap-2"><TrashIcon className="w-5 h-5" /> á›á»á”á€áŸ’ášá»á˜á…áŸ„á›</button></div>)}</div></div>)}
                        
                        <div className="bg-white p-3 shadow-sm flex items-center gap-3 z-20">
                            <button onClick={() => { setView('home'); setMessages([]); setActiveChat(null); }} className="text-gray-600 hover:bg-gray-100 p-2 rounded-full"><ArrowLeftIcon className="w-6 h-6" /></button>
                            <div className="flex-1 flex items-center gap-3 overflow-hidden">
                                <div className={`w-10 h-10 flex-shrink-0 rounded-full flex items-center justify-center text-white font-bold text-lg overflow-hidden ${activeChat.type === 'group' ? 'bg-indigo-500' : 'bg-gray-400'}`}>{activeChat.type === 'group' ? <UsersIcon className="w-5 h-5" /> : (activeChat.photoUrl ? <img src={activeChat.photoUrl} className="w-full h-full object-cover"/> : activeChat.name[0])}</div>
                                <div className="overflow-hidden">
                                    <h2 className="font-bold text-gray-800 truncate">{activeChat.name}</h2>
                                    <div className="flex items-center gap-1">
                                        {activeChat.type === 'direct' && partnerStatus === 'online' && <div className="w-2 h-2 rounded-full bg-green-500"></div>}
                                        <p className="text-xs text-gray-500 truncate">
                                            {activeChat.type === 'group' ? 'Group Chat' : (partnerStatus === 'online' ? 'Online' : 'Offline')}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-1">
                                <button onClick={() => initiateCall('audio')} className="p-2 text-blue-500 hover:bg-blue-50 rounded-full"><PhoneIcon className="w-5 h-5" /></button>
                                <button onClick={() => initiateCall('video')} className="p-2 text-blue-500 hover:bg-blue-50 rounded-full"><VideoCallIcon className="w-5 h-5" /></button>
                                {activeChat.type === 'group' && <button onClick={fetchGroupSettings} className="p-2 text-gray-500 hover:bg-gray-100 rounded-full"><SettingsIcon className="w-6 h-6" /></button>}
                            </div>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-2 space-y-4 bg-gray-100" onClick={() => { setMobileDeleteId(null); setActiveReactionId(null); }}>
                            {messages.map((msg) => { 
                                const isMe = msg.senderId === currentUser.uid; 
                                const showDelete = mobileDeleteId === msg.id; 
                                const showReactions = activeReactionId === msg.id;
                                return (
                                    <div key={msg.id} className={`flex w-full ${isMe ? 'justify-end' : 'justify-start'} group relative items-end`}>
                                        <div className={`flex items-end gap-2 max-w-[85%] sm:max-w-[70%] ${isMe ? 'flex-row-reverse' : 'flex-row'}`}>
                                            {isMe && <button onClick={(e) => { e.stopPropagation(); handleDeleteMessage(msg.id); }} className={`p-2 rounded-full bg-white shadow text-red-500 flex-shrink-0 ${showDelete ? 'opacity-100 scale-100' : 'opacity-0 scale-75 group-hover:opacity-100 group-hover:scale-100 hidden group-hover:block'}`}><TrashIcon className="w-4 h-4" /></button>}
                                            <div className="flex flex-col relative">
                                                {showReactions && (<div className="absolute -top-12 left-0 bg-white shadow-lg rounded-full px-3 py-1 flex gap-2 z-10 animate-slideIn border">{['â¤ï¸', 'ğŸ™', 'ğŸ˜', 'ğŸ˜‚'].map(emoji => (<button key={emoji} onClick={(e) => { e.stopPropagation(); handleAddReaction(msg.id, emoji); }} className="text-xl hover:scale-125 transition">{emoji}</button>))}</div>)}
                                                {!isMe && activeChat.type === 'group' && <span className="text-[10px] text-gray-500 ml-2 mb-1">{msg.senderName}</span>}
                                                
                                                <div 
                                                    onTouchStart={() => handleTouchStart(msg.id)} 
                                                    onTouchEnd={() => handleTouchEnd(msg)}
                                                    onClick={(e) => { if (window.matchMedia("(hover: hover)").matches && isMe) { e.stopPropagation(); handleClick(msg); } }} 
                                                    onContextMenu={(e) => handleContextMenu(e, msg)}
                                                    className={`px-4 py-2 rounded-2xl shadow-sm text-sm cursor-pointer select-none message-bubble relative overflow-hidden ${isMe ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white text-gray-800 rounded-tl-none'}`}
                                                >
                                                    {msg.type === 'image' ? ( <img src={msg.fileUrl} className="rounded-lg max-h-60 object-cover" /> ) : msg.type === 'video' ? ( <video src={msg.fileUrl} controls onPlay={handleMediaPlay} className="rounded-lg max-h-60 w-full" /> ) : msg.type === 'audio' ? ( <audio src={msg.fileUrl} controls onPlay={handleMediaPlay} className="w-full min-w-[150px] max-w-[240px]" /> ) : ( <span className="break-words">{msg.text}</span> )}
                                                    <div className="flex justify-end items-center gap-1 mt-1 opacity-70"><span className="text-[9px] italic">{msg.updatedAt ? 'á€áŸ‚' : ''} {new Date(msg.createdAt).toLocaleTimeString([],{hour:'2-digit', minute:'2-digit'})}</span>{isMe && getSeenInfo(msg)}</div>
                                                </div>
                                                {msg.reactions && (<div className={`flex gap-1 -mt-2 z-10 ${isMe ? 'justify-end mr-2' : 'ml-2'}`}>{Object.values(msg.reactions).slice(0, 3).map((r, i) => <span key={i} className="bg-white border rounded-full px-1 text-xs shadow-sm">{r}</span>)}{Object.values(msg.reactions).length > 3 && <span className="bg-white border rounded-full px-1 text-xs shadow-sm">+{Object.values(msg.reactions).length - 3}</span>}</div>)}
                                            </div>
                                        </div>
                                    </div>
                                ); 
                            })}
                            {uploadingItem && (<div className="flex w-full justify-end group relative items-center"><div className="flex items-end gap-2 max-w-[85%] sm:max-w-[70%] flex-row-reverse"><div className="flex flex-col"><div className="px-2 py-2 rounded-2xl shadow-sm text-sm select-none message-bubble relative overflow-hidden bg-blue-600 text-white rounded-tr-none"><div className="relative">{uploadingItem.type === 'image' ? ( <img src={uploadingItem.fileUrl} className="rounded-lg max-h-60 object-cover opacity-60" /> ) : uploadingItem.type === 'video' ? ( <video src={uploadingItem.fileUrl} className="rounded-lg max-h-60 w-full opacity-60" /> ) : ( <div className="flex items-center justify-center h-12 w-40 opacity-60"><MicIcon className="w-6 h-6" /></div> )}<div className="absolute inset-0 flex items-center justify-center"><Loader2Icon className="w-8 h-8 animate-spin text-white" /></div></div></div></div></div></div>)}
                            <div ref={messagesEndRef} />
                        </div>

                        <div className="bg-white p-2 border-t z-30 pb-safe">
                            {editingMessageId && <div className="flex justify-between items-center bg-yellow-50 px-3 py-1 mb-2 rounded text-xs text-yellow-700"><span>á€áŸ†á–á»á„á€áŸ‚á”áŸ’ášáŸ‚áŸá¶áš...</span><button onClick={() => { setEditingMessageId(null); setInputText(''); }}><XIcon className="w-4 h-4" /></button></div>}
                            
                            {isRecording ? (
                                <div className="flex items-center justify-between bg-red-50 p-3 rounded-full">
                                    <div className="flex items-center gap-2 text-red-600 font-bold animate-pulse"><div className="w-3 h-3 bg-red-600 rounded-full"></div><span>á€áŸ†á–á»á„áá...</span></div>
                                    <button onClick={stopRecording} className="p-2 bg-red-600 text-white rounded-full"><StopCircleIcon className="w-6 h-6"/></button>
                                </div>
                            ) : (
                                <div className="flex gap-2 items-center">
                                    {!isInputFocused ? (
                                        <>
                                            <button onClick={() => imageInputRef.current.click()} className="p-2 text-gray-500 hover:bg-gray-100 rounded-full flex-shrink-0"><ImageIcon className="w-6 h-6"/></button>
                                            <button onClick={() => videoInputRef.current.click()} className="p-2 text-gray-500 hover:bg-gray-100 rounded-full flex-shrink-0"><VideoIcon className="w-6 h-6"/></button>
                                            <button onClick={startRecording} className="p-2 text-gray-500 hover:bg-gray-100 rounded-full flex-shrink-0"><MicIcon className="w-6 h-6"/></button>
                                        </>
                                    ) : (
                                        <button onClick={() => setIsInputFocused(false)} className="p-2 text-blue-500 hover:bg-blue-50 rounded-full flex-shrink-0"><PlusCircleIcon className="w-7 h-7"/></button>
                                    )}
                                    <form onSubmit={handleSendMessage} className="flex-1 flex gap-2">
                                        <input ref={inputRef} type="text" value={inputText} onChange={(e) => setInputText(e.target.value)} placeholder="áŸášáŸáŸášáŸá¶áš..." className="flex-1 px-4 py-3 bg-gray-100 rounded-full focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition min-w-0" onFocus={() => setIsInputFocused(true)}/>
                                        <button disabled={!inputText.trim()} type="submit" className="p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 disabled:opacity-50 shadow-lg flex-shrink-0">{editingMessageId ? <CheckIcon className="w-5 h-5"/> : <SendIcon className="w-5 h-5"/>}</button>
                                    </form>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }
            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
