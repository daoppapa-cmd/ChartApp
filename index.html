<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីជជែកកម្សាន្ត</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Font: Battambang -->
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Battambang', cursive;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .message-bubble {
            transition: all 0.2s;
            user-select: none;
            -webkit-user-select: none;
        }
        /* Animation for modal */
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-content {
            animation: slideIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <!-- Firebase Configuration & Setup -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getDatabase, ref, push, set, onValue, update, remove, get, child, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js';

        window.fb = {
            initializeApp,
            getDatabase,
            ref,
            push,
            set,
            onValue,
            update,
            remove,
            get,
            child,
            query,
            orderByChild,
            equalTo
        };

        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <!-- React Application Logic -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const SendIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>);
        const Loader2Icon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>);
        const SearchIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>);
        const ArrowLeftIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>);
        const UserIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>);
        const UsersIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>);
        const EditIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>);
        const TrashIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>);
        const XIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>);
        const CheckIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"></polyline></svg>);
        const LogoutIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>);
        const LockIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>);
        const SettingsIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>);
        const PlusIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>);
        const CopyIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>);
        const UserMinusIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="23" y1="11" x2="17" y2="11"></line></svg>);

        function App() {
            const [firebaseReady, setFirebaseReady] = useState(false);
            const [view, setView] = useState('loading');
            const [currentUser, setCurrentUser] = useState(null);
            
            // Home View States
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResult, setSearchResult] = useState(null);
            const [searchError, setSearchError] = useState('');
            const [myGroups, setMyGroups] = useState([]); 
            const [recentChats, setRecentChats] = useState([]); // New: List of recent DMs
            const [activeTab, setActiveTab] = useState('chats'); // Changed 'search' to 'chats'
            
            // Chat States
            const [activeChat, setActiveChat] = useState(null);
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState('');
            const [editingMessageId, setEditingMessageId] = useState(null);
            const [mobileDeleteId, setMobileDeleteId] = useState(null);

            // Modal States
            const [showPasswordModal, setShowPasswordModal] = useState(false);
            const [newPassword, setNewPassword] = useState('');
            const [showGroupModal, setShowGroupModal] = useState(false);
            const [showSettingsModal, setShowSettingsModal] = useState(false);

            // Group Modal Inputs
            const [groupName, setGroupName] = useState('');
            const [groupJoinCode, setGroupJoinCode] = useState('');
            
            // Group Settings Data
            const [groupMembers, setGroupMembers] = useState([]);
            const [groupBlocked, setGroupBlocked] = useState([]);
            const [addMemberQuery, setAddMemberQuery] = useState('');

            const appRef = useRef(null);
            const dbRef = useRef(null);
            const messagesEndRef = useRef(null);
            const inputRef = useRef(null);
            const longPressTimerRef = useRef(null);
            const deviceIdRef = useRef(null);

            // 1. Initialize Firebase
            useEffect(() => {
                const initFirebase = () => {
                    if (window.fb) {
                        try {
                            const getFirebaseConfig = () => {
                                let config = {
                                    apiKey: "AIzaSyCPTS4NN_cbPggJBfDveLzBzr6nA5ziVpw",
                                    authDomain: "chartapp-e99be.firebaseapp.com",
                                    projectId: "chartapp-e99be",
                                    databaseURL: "https://chartapp-e99be-default-rtdb.firebaseio.com/"
                                };
                                try {
                                    if (typeof window.__firebase_config !== 'undefined') {
                                        const sysConfig = JSON.parse(window.__firebase_config);
                                        config = { ...config, ...sysConfig };
                                        if (!config.databaseURL) config.databaseURL = "https://chartapp-e99be-default-rtdb.firebaseio.com/";
                                    }
                                } catch (e) { }
                                return config;
                            };

                            const config = getFirebaseConfig();
                            const app = window.fb.initializeApp(config);
                            const db = window.fb.getDatabase(app);

                            appRef.current = app;
                            dbRef.current = db;
                            setFirebaseReady(true);

                            let dId = localStorage.getItem('device_unique_id');
                            if (!dId) {
                                dId = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                                localStorage.setItem('device_unique_id', dId);
                            }
                            deviceIdRef.current = dId;

                        } catch (err) {
                            console.error("Firebase init failed:", err);
                        }
                    }
                };

                if (window.fb) initFirebase();
                else window.addEventListener('firebase-ready', initFirebase);
                return () => window.removeEventListener('firebase-ready', initFirebase);
            }, []);

            // 2. Check Auth Status
            useEffect(() => {
                if (!firebaseReady) return;
                const checkAuth = async () => {
                    const localUid = localStorage.getItem('chat_app_uid');
                    if (localUid) {
                        const db = dbRef.current;
                        try {
                            const userSnapshot = await window.fb.get(window.fb.ref(db, `users/${localUid}`));
                            if (userSnapshot.exists()) {
                                setCurrentUser({ uid: localUid, ...userSnapshot.val() });
                                setView('home');
                            } else {
                                localStorage.removeItem('chat_app_uid');
                                setView('login');
                            }
                        } catch (e) { setView('login'); }
                    } else { setView('login'); }
                };
                checkAuth();
            }, [firebaseReady]);

            // 3. Fetch User's Groups & Recent Chats
            useEffect(() => {
                if (view !== 'home' || !currentUser || !firebaseReady) return;
                
                const db = dbRef.current;
                
                // Fetch Groups
                const userGroupsRef = window.fb.ref(db, `user_groups/${currentUser.uid}`);
                const unsubscribeGroups = window.fb.onValue(userGroupsRef, async (snapshot) => {
                    if (snapshot.exists()) {
                        const groupsObj = snapshot.val();
                        const groupIds = Object.keys(groupsObj);
                        const loadedGroups = [];
                        
                        for (const gid of groupIds) {
                            const gSnap = await window.fb.get(window.fb.ref(db, `groups/${gid}`));
                            if (gSnap.exists()) {
                                loadedGroups.push({ id: gid, ...gSnap.val() });
                            }
                        }
                        setMyGroups(loadedGroups);
                    } else {
                        setMyGroups([]);
                    }
                });

                // Fetch Recent Chats
                const recentChatsRef = window.fb.ref(db, `user_chats/${currentUser.uid}`);
                const unsubscribeChats = window.fb.onValue(recentChatsRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const chatsData = snapshot.val();
                        const chatsList = Object.keys(chatsData).map(key => ({
                            partnerId: key,
                            ...chatsData[key]
                        }));
                        // Sort by timestamp (newest first)
                        chatsList.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                        setRecentChats(chatsList);
                    } else {
                        setRecentChats([]);
                    }
                });

                return () => {
                    unsubscribeGroups();
                    unsubscribeChats();
                };
            }, [view, currentUser, firebaseReady]);

            // --- Helper Functions ---
            const copyToClipboard = (text) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    const successful = document.execCommand('copy');
                    successful ? alert("បានចម្លង: " + text) : alert("បរាជ័យក្នុងការចម្លង");
                } catch (err) { alert("មានបញ្ហាក្នុងការចម្លង"); }
                document.body.removeChild(textArea);
            };

            // --- Auth Handlers ---
            const handleRegister = async (name) => {
                if (!name.trim()) return;
                const db = dbRef.current;
                const newUid = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                const cleanName = name.replace(/\s+/g, '').substring(0, 10);
                const randomSuffix = Math.floor(100 + Math.random() * 900);
                const newUsername = `@${cleanName}_${randomSuffix}`;
                const userData = { username: name, tag: newUsername, deviceId: deviceIdRef.current, createdAt: Date.now() };
                try {
                    await window.fb.set(window.fb.ref(db, `users/${newUid}`), userData);
                    await window.fb.set(window.fb.ref(db, `usernames/${newUsername}`), newUid);
                    localStorage.setItem('chat_app_uid', newUid);
                    setCurrentUser({ uid: newUid, ...userData });
                    setView('home');
                } catch (e) { alert("បរាជ័យក្នុងការបង្កើតគណនី។"); }
            };

            const handleLogin = async (name, tag, password) => {
                const db = dbRef.current;
                try {
                    const snapshot = await window.fb.get(window.fb.ref(db, `usernames/${tag.trim()}`));
                    if (!snapshot.exists()) { alert("រកមិនឃើញ Username នេះទេ។"); return; }
                    const uid = snapshot.val();
                    const userSnap = await window.fb.get(window.fb.ref(db, `users/${uid}`));
                    if (!userSnap.exists()) return;
                    const userData = userSnap.val();
                    if (userData.username !== name.trim()) { alert("ឈ្មោះមិនត្រឹមត្រូវ។"); return; }
                    
                    if (userData.deviceId === deviceIdRef.current) {
                        localStorage.setItem('chat_app_uid', uid);
                        setCurrentUser({ uid, ...userData });
                        setView('home');
                    } else {
                        if (userData.password) {
                            if (userData.password === password) {
                                localStorage.setItem('chat_app_uid', uid);
                                setCurrentUser({ uid, ...userData });
                                setView('home');
                            } else { alert("Password មិនត្រឹមត្រូវ។"); }
                        } else {
                            await window.fb.update(window.fb.ref(db, `users/${uid}`), { deviceId: deviceIdRef.current });
                            localStorage.setItem('chat_app_uid', uid);
                            setCurrentUser({ uid, ...userData, deviceId: deviceIdRef.current });
                            setView('home');
                        }
                    }
                } catch (e) { alert("មានបញ្ហា។"); }
            };

            const savePasswordAndLogout = async () => {
                if (!newPassword.trim()) return;
                try {
                    await window.fb.update(window.fb.ref(dbRef.current, `users/${currentUser.uid}`), { password: newPassword });
                    setShowPasswordModal(false);
                    performLogout();
                } catch (e) { alert("បរាជ័យ។"); }
            };

            const performLogout = () => {
                localStorage.removeItem('chat_app_uid');
                setCurrentUser(null);
                setActiveChat(null);
                setMessages([]);
                setView('login');
            };

            // --- Group Handlers ---
            const handleCreateGroup = async () => {
                if (!groupName.trim()) return;
                const db = dbRef.current;
                const groupId = 'group_' + Date.now() + Math.random().toString(36).substr(2, 5);
                const inviteCode = Math.random().toString(36).substr(2, 8).toUpperCase();
                
                const groupData = {
                    name: groupName,
                    owner: currentUser.uid,
                    inviteCode: inviteCode,
                    createdAt: Date.now(),
                    members: { [currentUser.uid]: true }
                };

                try {
                    await window.fb.set(window.fb.ref(db, `groups/${groupId}`), groupData);
                    await window.fb.set(window.fb.ref(db, `user_groups/${currentUser.uid}/${groupId}`), true);
                    await window.fb.set(window.fb.ref(db, `group_invites/${inviteCode}`), groupId);
                    
                    setGroupName('');
                    setShowGroupModal(false);
                    alert(`បានបង្កើតក្រុមជោគជ័យ! លេខកូដក្រុម៖ ${inviteCode}`);
                } catch (e) { alert("បរាជ័យក្នុងការបង្កើតក្រុម។"); }
            };

            const handleJoinGroup = async () => {
                if (!groupJoinCode.trim()) return;
                const db = dbRef.current;
                try {
                    const codeSnap = await window.fb.get(window.fb.ref(db, `group_invites/${groupJoinCode.trim()}`));
                    if (!codeSnap.exists()) { alert("លេខកូដមិនត្រឹមត្រូវ។"); return; }
                    const groupId = codeSnap.val();

                    const blockedSnap = await window.fb.get(window.fb.ref(db, `groups/${groupId}/blocked/${currentUser.uid}`));
                    if (blockedSnap.exists()) { alert("អ្នកត្រូវបានបិទ (Block) ពីក្រុមនេះ។"); return; }

                    await window.fb.set(window.fb.ref(db, `groups/${groupId}/members/${currentUser.uid}`), true);
                    await window.fb.set(window.fb.ref(db, `user_groups/${currentUser.uid}/${groupId}`), true);
                    
                    setGroupJoinCode('');
                    setShowGroupModal(false);
                    alert("ចូលក្រុមបានជោគជ័យ!");
                } catch (e) { alert("មានបញ្ហាក្នុងការចូលក្រុម។"); }
            };

            const handleDeleteGroup = async () => {
                if (!window.confirm("តើអ្នកពិតជាចង់លុបក្រុមនេះមែនទេ? សកម្មភាពនេះមិនអាចត្រឡប់វិញបានទេ។")) return;
                const db = dbRef.current;
                const groupId = activeChat.id;
                
                try {
                    // Try to remove from all members if possible (best effort cleanup)
                    if (groupMembers.length > 0) {
                        const updates = {};
                        groupMembers.forEach(m => {
                            updates[`user_groups/${m.uid}/${groupId}`] = null;
                        });
                        await window.fb.update(window.fb.ref(db), updates);
                    }

                    // Remove main data
                    await window.fb.remove(window.fb.ref(db, `groups/${groupId}`));
                    await window.fb.remove(window.fb.ref(db, `messages/${groupId}`));
                    await window.fb.remove(window.fb.ref(db, `group_invites/${activeChat.inviteCode}`));

                    setShowSettingsModal(false);
                    setView('home');
                    setActiveChat(null);
                    alert("បានលុបក្រុមជោគជ័យ។");
                } catch (e) {
                    alert("មានបញ្ហាក្នុងការលុបក្រុម។");
                }
            };

            const handleDeleteRecentChat = async (partnerId, e) => {
                e.stopPropagation();
                if (!window.confirm("តើអ្នកចង់លុបការសន្ទនានេះចេញពីបញ្ជីមែនទេ?")) return;
                const db = dbRef.current;
                try {
                    await window.fb.remove(window.fb.ref(db, `user_chats/${currentUser.uid}/${partnerId}`));
                } catch (e) {
                    console.error(e);
                }
            };

            // --- Chat Handlers ---
            const startChat = (partner) => {
                const uids = [currentUser.uid, partner.uid].sort();
                const chatId = `${uids[0]}_${uids[1]}`;
                setActiveChat({
                    id: chatId,
                    type: 'direct',
                    name: partner.username,
                    tag: partner.tag,
                    partnerId: partner.uid
                });
                setView('chat');
                setSearchResult(null);
                setSearchQuery('');
            };

            const startGroupChat = (group) => {
                setActiveChat({
                    id: group.id,
                    type: 'group',
                    name: group.name,
                    owner: group.owner,
                    inviteCode: group.inviteCode
                });
                setView('chat');
            };

            const fetchGroupSettings = async () => {
                if (!activeChat || activeChat.type !== 'group') return;
                const db = dbRef.current;
                const membersSnap = await window.fb.get(window.fb.ref(db, `groups/${activeChat.id}/members`));
                const blockedSnap = await window.fb.get(window.fb.ref(db, `groups/${activeChat.id}/blocked`));
                
                const membersList = [];
                if (membersSnap.exists()) {
                    const memberIds = Object.keys(membersSnap.val());
                    for (const mid of memberIds) {
                        const userSnap = await window.fb.get(window.fb.ref(db, `users/${mid}`));
                        if (userSnap.exists()) membersList.push({ uid: mid, ...userSnap.val() });
                    }
                }
                
                const blockedList = [];
                if (blockedSnap.exists()) {
                    const blockedIds = Object.keys(blockedSnap.val());
                    for (const bid of blockedIds) {
                        const userSnap = await window.fb.get(window.fb.ref(db, `users/${bid}`));
                        if (userSnap.exists()) blockedList.push({ uid: bid, ...userSnap.val() });
                    }
                }

                setGroupMembers(membersList);
                setGroupBlocked(blockedList);
                setShowSettingsModal(true);
            };

            const handleAddMember = async () => {
                if (!addMemberQuery.trim()) return;
                const db = dbRef.current;
                try {
                    const snap = await window.fb.get(window.fb.ref(db, `usernames/${addMemberQuery.trim()}`));
                    if (!snap.exists()) { alert("រកមិនឃើញ Username នេះទេ។"); return; }
                    const uidToAdd = snap.val();
                    
                    const blockedSnap = await window.fb.get(window.fb.ref(db, `groups/${activeChat.id}/blocked/${uidToAdd}`));
                    if (blockedSnap.exists()) { alert("អ្នកប្រើប្រាស់នេះកំពុងជាប់ Block។ សូម Unblock ជាមុនសិន។"); return; }

                    await window.fb.set(window.fb.ref(db, `groups/${activeChat.id}/members/${uidToAdd}`), true);
                    await window.fb.set(window.fb.ref(db, `user_groups/${uidToAdd}/${activeChat.id}`), true);
                    
                    setAddMemberQuery('');
                    fetchGroupSettings();
                    alert("បានបន្ថែមសមាជិក។");
                } catch (e) { alert("មានបញ្ហា។"); }
            };

            const handleRemoveMember = async (memberId) => {
                if (!window.confirm("តើអ្នកចង់ដកសមាជិកនេះចេញមែនទេ?")) return;
                const db = dbRef.current;
                try {
                    await window.fb.remove(window.fb.ref(db, `groups/${activeChat.id}/members/${memberId}`));
                    await window.fb.remove(window.fb.ref(db, `user_groups/${memberId}/${activeChat.id}`));
                    await window.fb.set(window.fb.ref(db, `groups/${activeChat.id}/blocked/${memberId}`), true);
                    fetchGroupSettings();
                } catch (e) { alert("បរាជ័យ។"); }
            };

            const handleUnblockMember = async (memberId) => {
                const db = dbRef.current;
                try {
                    await window.fb.remove(window.fb.ref(db, `groups/${activeChat.id}/blocked/${memberId}`));
                    fetchGroupSettings();
                } catch (e) { alert("បរាជ័យ។"); }
            };

            // Message Logic
            useEffect(() => {
                if (view !== 'chat' || !activeChat || !firebaseReady) return;
                const db = dbRef.current;
                const messagesRef = window.fb.ref(db, `messages/${activeChat.id}`);
                const unsubscribe = window.fb.onValue(messagesRef, (snapshot) => {
                    const data = snapshot.val();
                    const msgs = [];
                    if (data) Object.keys(data).forEach(key => msgs.push({ id: key, ...data[key] }));
                    msgs.sort((a, b) => a.createdAt - b.createdAt);
                    setMessages(msgs);
                });
                return () => unsubscribe();
            }, [view, activeChat, firebaseReady]);

            useEffect(() => { if(view === 'chat') messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages, view]);

            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (!inputText.trim() || !activeChat) return;
                const text = inputText;
                setInputText('');
                const db = dbRef.current;
                const timestamp = Date.now();

                try {
                    if (editingMessageId) {
                        await window.fb.update(window.fb.ref(db, `messages/${activeChat.id}/${editingMessageId}`), { text: text, updatedAt: timestamp });
                        setEditingMessageId(null);
                    } else {
                        await window.fb.push(window.fb.ref(db, `messages/${activeChat.id}`), { 
                            text: text, 
                            senderId: currentUser.uid,
                            senderName: currentUser.username,
                            createdAt: timestamp 
                        });

                        // Update Recent Chats for Direct Messages
                        if (activeChat.type === 'direct') {
                            // My View
                            await window.fb.update(window.fb.ref(db, `user_chats/${currentUser.uid}/${activeChat.partnerId}`), {
                                name: activeChat.name,
                                tag: activeChat.tag,
                                uid: activeChat.partnerId, // Keep uid for restarting chat
                                lastMsg: text,
                                timestamp: timestamp
                            });
                            // Partner View
                            await window.fb.update(window.fb.ref(db, `user_chats/${activeChat.partnerId}/${currentUser.uid}`), {
                                name: currentUser.username,
                                tag: currentUser.tag,
                                uid: currentUser.uid,
                                lastMsg: text,
                                timestamp: timestamp
                            });
                        }
                    }
                } catch (e) { setInputText(text); }
            };

            const handleDeleteMessage = async (msgId) => {
                if(window.confirm("លុបសារនេះ?")) {
                    const db = dbRef.current;
                    await window.fb.remove(window.fb.ref(db, `messages/${activeChat.id}/${msgId}`));
                    if(editingMessageId === msgId) { setEditingMessageId(null); setInputText(''); }
                    setMobileDeleteId(null);
                }
            };
            const handleEditMessage = (msg) => { setEditingMessageId(msg.id); setInputText(msg.text); setMobileDeleteId(null); setTimeout(() => inputRef.current?.focus(), 100); };
            const handleTouchStart = (msgId) => { longPressTimerRef.current = setTimeout(() => { setMobileDeleteId(msgId); longPressTimerRef.current = null; }, 500); };
            const handleTouchEnd = (msg) => { if (longPressTimerRef.current) { clearTimeout(longPressTimerRef.current); longPressTimerRef.current = null; if (mobileDeleteId !== msg.id) handleEditMessage(msg); else setMobileDeleteId(null); } };
            const handleClick = (msg) => { if (window.matchMedia("(hover: hover)").matches) handleEditMessage(msg); };

            const handleSearch = async (e) => {
                e.preventDefault();
                setSearchResult(null);
                setSearchError('');
                if (!searchQuery.startsWith('@')) { setSearchError("ឈ្មោះសម្គាល់ត្រូវចាប់ផ្តើមដោយ @"); return; }
                const db = dbRef.current;
                try {
                    const snapshot = await window.fb.get(window.fb.ref(db, `usernames/${searchQuery}`));
                    if (snapshot.exists()) {
                        const partnerUid = snapshot.val();
                        if (partnerUid === currentUser.uid) { setSearchError("នេះជាគណនីរបស់អ្នក!"); return; }
                        const partnerSnapshot = await window.fb.get(window.fb.ref(db, `users/${partnerUid}`));
                        if (partnerSnapshot.exists()) setSearchResult({ uid: partnerUid, ...partnerSnapshot.val() });
                    } else { setSearchError("រកមិនឃើញអ្នកប្រើប្រាស់នេះទេ។"); }
                } catch (e) { setSearchError("មានបញ្ហាក្នុងការស្វែងរក។"); }
            };

            // --- Views ---
            if (view === 'loading') return (<div className="flex items-center justify-center h-full"><Loader2Icon className="animate-spin text-blue-500 w-10 h-10" /></div>);
            if (view === 'login') return <LoginView onRegister={handleRegister} onLogin={handleLogin} />;

            if (view === 'home') {
                return (
                    <div className="flex flex-col h-full bg-gray-50 max-w-md mx-auto shadow-2xl overflow-hidden relative">
                        {/* Modals */}
                        {showPasswordModal && (
                            <div className="absolute inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
                                <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-xl modal-content">
                                    <h3 className="font-bold text-lg text-center mb-4">បង្កើត Password ដើម្បី Logout</h3>
                                    <input type="password" placeholder="Password ថ្មី..." className="w-full px-4 py-3 rounded-xl border mb-4" value={newPassword} onChange={(e) => setNewPassword(e.target.value)}/>
                                    <div className="flex gap-2"><button onClick={() => setShowPasswordModal(false)} className="flex-1 py-2 bg-gray-200 rounded-lg">បោះបង់</button><button onClick={savePasswordAndLogout} className="flex-1 py-2 bg-blue-600 text-white rounded-lg">រក្សាទុក & Logout</button></div>
                                </div>
                            </div>
                        )}
                        {showGroupModal && (
                            <div className="absolute inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
                                <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-xl modal-content">
                                    <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg">បង្កើត ឬ ចូលក្រុម</h3><button onClick={() => setShowGroupModal(false)}><XIcon className="w-6 h-6 text-gray-500"/></button></div>
                                    
                                    <div className="mb-6">
                                        <p className="text-sm font-bold text-blue-600 mb-2">បង្កើតក្រុមថ្មី</p>
                                        <div className="flex gap-2">
                                            <input type="text" placeholder="ឈ្មោះក្រុម..." className="flex-1 px-3 py-2 border rounded-lg" value={groupName} onChange={(e)=>setGroupName(e.target.value)}/>
                                            <button onClick={handleCreateGroup} className="bg-blue-600 text-white px-4 rounded-lg text-sm">បង្កើត</button>
                                        </div>
                                    </div>
                                    <div className="border-t pt-4">
                                        <p className="text-sm font-bold text-green-600 mb-2">ចូលក្រុម (Join)</p>
                                        <div className="flex gap-2">
                                            <input type="text" placeholder="លេខកូដក្រុម..." className="flex-1 px-3 py-2 border rounded-lg" value={groupJoinCode} onChange={(e)=>setGroupJoinCode(e.target.value)}/>
                                            <button onClick={handleJoinGroup} className="bg-green-600 text-white px-4 rounded-lg text-sm">ចូល</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Header */}
                        <div className="bg-blue-600 p-6 text-white rounded-b-3xl shadow-md z-10">
                            <div className="flex justify-between items-start mb-4">
                                <h1 className="text-2xl font-bold">កម្មវិធីជជែកកម្សាន្ត</h1>
                                <button onClick={() => (!currentUser.password ? setShowPasswordModal(true) : performLogout())}><LogoutIcon className="w-6 h-6" /></button>
                            </div>
                            <div className="flex items-center gap-2 opacity-90 text-sm bg-blue-700 p-2 rounded-lg inline-block">
                                <UserIcon className="w-4 h-4" /> <span>{currentUser.username}</span>
                                <span className="font-mono bg-blue-800 px-2 py-0.5 rounded text-xs cursor-pointer" onClick={() => copyToClipboard(currentUser.tag)}>{currentUser.tag}</span>
                            </div>
                        </div>

                        {/* Tabs */}
                        <div className="flex p-4 gap-4">
                            <button onClick={() => setActiveTab('chats')} className={`flex-1 py-2 rounded-xl font-bold transition ${activeTab === 'chats' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>ការសន្ទនា</button>
                            <button onClick={() => setActiveTab('groups')} className={`flex-1 py-2 rounded-xl font-bold transition ${activeTab === 'groups' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>ក្រុមរបស់ខ្ញុំ</button>
                        </div>

                        <div className="flex-1 overflow-y-auto px-4 pb-4">
                            {activeTab === 'chats' ? (
                                <div>
                                    <form onSubmit={handleSearch} className="flex gap-2 mb-4">
                                        <input type="text" placeholder="ស្វែងរក @username..." className="flex-1 px-4 py-3 rounded-xl border focus:ring-2 focus:ring-blue-500 outline-none" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)}/>
                                        <button type="submit" className="bg-blue-600 text-white p-3 rounded-xl shadow-md"><SearchIcon className="w-6 h-6" /></button>
                                    </form>
                                    
                                    {searchError && <p className="text-red-500 text-sm bg-red-50 p-2 rounded text-center mb-2">{searchError}</p>}
                                    
                                    {/* Search Result */}
                                    {searchResult && (
                                        <div className="bg-white p-4 rounded-xl shadow flex items-center justify-between mb-4 border-2 border-blue-100">
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white font-bold">{searchResult.username[0]}</div>
                                                <div><p className="font-bold text-gray-800">{searchResult.username}</p><p className="text-xs text-gray-500">{searchResult.tag}</p></div>
                                            </div>
                                            <button onClick={() => startChat(searchResult)} className="bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-green-600">ជជែក</button>
                                        </div>
                                    )}

                                    {/* Recent Chats List */}
                                    <div className="space-y-2">
                                        {recentChats.length > 0 && !searchQuery && <p className="text-xs font-bold text-gray-400 mb-2 uppercase">ការសន្ទនាថ្មីៗ</p>}
                                        {recentChats.map(chat => (
                                            <div key={chat.partnerId} onClick={() => startChat({uid: chat.partnerId, username: chat.name, tag: chat.tag})} className="bg-white p-3 rounded-xl shadow-sm flex items-center gap-3 cursor-pointer hover:bg-gray-50 transition group relative">
                                                <div className="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center text-gray-600 font-bold">{chat.name[0]}</div>
                                                <div className="flex-1 overflow-hidden">
                                                    <div className="flex justify-between items-center">
                                                        <p className="font-bold text-gray-800 truncate">{chat.name}</p>
                                                        {chat.timestamp && <span className="text-[10px] text-gray-400">{new Date(chat.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>}
                                                    </div>
                                                    <p className="text-xs text-gray-500 truncate">{chat.lastMsg || 'គ្មានសារ'}</p>
                                                </div>
                                                <button 
                                                    onClick={(e) => handleDeleteRecentChat(chat.partnerId, e)}
                                                    className="opacity-0 group-hover:opacity-100 p-2 text-gray-300 hover:text-red-500 transition"
                                                    title="លុបការសន្ទនា"
                                                >
                                                    <TrashIcon className="w-4 h-4" />
                                                </button>
                                            </div>
                                        ))}
                                        {recentChats.length === 0 && !searchResult && <div className="text-center text-gray-400 mt-8"><p>មិនទាន់មានការសន្ទនាទេ។</p><p className="text-xs mt-1">ស្វែងរកមិត្តភក្តិដើម្បីចាប់ផ្តើម!</p></div>}
                                    </div>
                                </div>
                            ) : (
                                <div className="space-y-2">
                                    <button onClick={() => setShowGroupModal(true)} className="w-full py-3 border-2 border-dashed border-blue-300 text-blue-500 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-blue-50">+ បង្កើត ឬ ចូលក្រុមថ្មី</button>
                                    {myGroups.map(g => (
                                        <div key={g.id} onClick={() => startGroupChat(g)} className="bg-white p-4 rounded-xl shadow flex items-center gap-3 cursor-pointer hover:bg-gray-50">
                                            <div className="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center"><UsersIcon className="w-6 h-6"/></div>
                                            <div><p className="font-bold text-gray-800">{g.name}</p><p className="text-xs text-gray-500">Code: {g.inviteCode}</p></div>
                                        </div>
                                    ))}
                                    {myGroups.length === 0 && <p className="text-center text-gray-400 mt-4">មិនទាន់មានក្រុមទេ។</p>}
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            if (view === 'chat') {
                const isOwner = activeChat.type === 'group' && activeChat.owner === currentUser.uid;
                return (
                    <div className="flex flex-col h-full bg-gray-100 font-battambang max-w-md mx-auto shadow-2xl relative">
                        {/* Settings Modal */}
                        {showSettingsModal && (
                            <div className="absolute inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
                                <div className="bg-white p-4 rounded-2xl w-full max-w-sm shadow-xl modal-content h-[80vh] flex flex-col">
                                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                                        <h3 className="font-bold text-lg">ការកំណត់ក្រុម: {activeChat.name}</h3>
                                        <button onClick={() => setShowSettingsModal(false)}><XIcon className="w-6 h-6 text-gray-500"/></button>
                                    </div>
                                    
                                    <div className="mb-4 bg-blue-50 p-3 rounded-lg">
                                        <p className="text-xs text-gray-500 uppercase">លេខកូដក្រុម</p>
                                        <div className="flex justify-between items-center font-mono font-bold text-blue-700">
                                            {activeChat.inviteCode}
                                            <button onClick={() => copyToClipboard(activeChat.inviteCode)}><CopyIcon className="w-4 h-4"/></button>
                                        </div>
                                    </div>

                                    <div className="mb-4">
                                        <p className="text-sm font-bold mb-2">បន្ថែមសមាជិក</p>
                                        <div className="flex gap-2">
                                            <input type="text" placeholder="@username..." className="flex-1 px-3 py-2 border rounded-lg" value={addMemberQuery} onChange={(e)=>setAddMemberQuery(e.target.value)}/>
                                            <button onClick={handleAddMember} className="bg-blue-600 text-white px-3 rounded-lg text-sm">បន្ថែម</button>
                                        </div>
                                    </div>

                                    <div className="flex-1 overflow-y-auto mb-4">
                                        <p className="text-sm font-bold mb-2">សមាជិក ({groupMembers.length})</p>
                                        <div className="space-y-2 mb-4">
                                            {groupMembers.map(m => (
                                                <div key={m.uid} className="flex justify-between items-center bg-gray-50 p-2 rounded">
                                                    <span className="text-sm">{m.username} <span className="text-xs text-gray-400">{m.tag}</span></span>
                                                    {m.uid !== currentUser.uid && (
                                                        <button onClick={() => handleRemoveMember(m.uid)} className="text-red-500 bg-red-100 p-1 rounded"><UserMinusIcon className="w-4 h-4"/></button>
                                                    )}
                                                </div>
                                            ))}
                                        </div>

                                        {groupBlocked.length > 0 && (
                                            <div>
                                                <p className="text-sm font-bold mb-2 text-red-600">អ្នកដែលត្រូវបាន Block</p>
                                                <div className="space-y-2">
                                                    {groupBlocked.map(b => (
                                                        <div key={b.uid} className="flex justify-between items-center bg-red-50 p-2 rounded border border-red-100">
                                                            <span className="text-sm text-gray-600">{b.username}</span>
                                                            <button onClick={() => handleUnblockMember(b.uid)} className="text-green-600 text-xs font-bold">Unblock</button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Delete Group Button (Owner Only) */}
                                    {isOwner && (
                                        <div className="pt-2 border-t">
                                            <button onClick={handleDeleteGroup} className="w-full py-3 bg-red-50 text-red-600 font-bold rounded-lg hover:bg-red-100 transition flex items-center justify-center gap-2">
                                                <TrashIcon className="w-5 h-5" /> លុបក្រុមចោល
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        <div className="bg-white p-4 shadow-sm flex items-center gap-3 z-20">
                            <button onClick={() => { setView('home'); setMessages([]); setActiveChat(null); setShowSettingsModal(false); }} className="text-gray-600 hover:bg-gray-100 p-2 rounded-full"><ArrowLeftIcon className="w-6 h-6" /></button>
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-lg ${activeChat.type === 'group' ? 'bg-indigo-500' : 'bg-gradient-to-br from-green-400 to-blue-500'}`}>
                                {activeChat.type === 'group' ? <UsersIcon className="w-5 h-5" /> : activeChat.name[0]}
                            </div>
                            <div className="flex-1">
                                <h2 className="font-bold text-gray-800">{activeChat.name}</h2>
                                <p className="text-xs text-gray-500">{activeChat.type === 'group' ? 'Group Chat' : activeChat.tag}</p>
                            </div>
                            {isOwner && (
                                <button onClick={fetchGroupSettings} className="p-2 text-gray-500 hover:bg-gray-100 rounded-full"><SettingsIcon className="w-6 h-6" /></button>
                            )}
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-100" onClick={() => setMobileDeleteId(null)}>
                            {messages.map((msg) => {
                                const isMe = msg.senderId === currentUser.uid;
                                const showDelete = mobileDeleteId === msg.id;
                                return (
                                    <div key={msg.id} className={`flex w-full ${isMe ? 'justify-end' : 'justify-start'} group relative items-center`}>
                                        <div className={`flex items-center gap-2 max-w-[85%] ${isMe ? 'flex-row-reverse' : 'flex-row'}`}>
                                            {isMe && <button onClick={(e) => { e.stopPropagation(); handleDeleteMessage(msg.id); }} className={`p-2 rounded-full bg-white shadow text-red-500 ${showDelete ? 'opacity-100 scale-100' : 'opacity-0 scale-75 group-hover:opacity-100 group-hover:scale-100 hidden group-hover:block'}`}><TrashIcon className="w-4 h-4" /></button>}
                                            <div className="flex flex-col">
                                                {!isMe && activeChat.type === 'group' && <span className="text-[10px] text-gray-500 ml-2 mb-1">{msg.senderName}</span>}
                                                <div 
                                                    onTouchStart={() => isMe && handleTouchStart(msg.id)} 
                                                    onTouchEnd={() => isMe && handleTouchEnd(msg)} 
                                                    onClick={(e) => { if (window.matchMedia("(hover: hover)").matches && isMe) { e.stopPropagation(); handleClick(msg); } }} 
                                                    className={`px-4 py-2 rounded-2xl break-words shadow-sm text-sm cursor-pointer select-none message-bubble relative ${isMe ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white text-gray-800 rounded-tl-none'} ${editingMessageId === msg.id ? 'ring-2 ring-yellow-400' : ''}`}
                                                >
                                                    {msg.text}
                                                    {msg.updatedAt && <span className="text-[10px] opacity-70 block text-right italic mt-1">បានកែ</span>}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                            <div ref={messagesEndRef} />
                        </div>

                        <div className="bg-white p-3 border-t z-30">
                            {editingMessageId && <div className="flex justify-between items-center bg-yellow-50 px-3 py-1 mb-2 rounded text-xs text-yellow-700"><span>កំពុងកែប្រែសារ...</span><button onClick={() => { setEditingMessageId(null); setInputText(''); }}><XIcon className="w-4 h-4" /></button></div>}
                            <form onSubmit={handleSendMessage} className="flex gap-2">
                                <input ref={inputRef} type="text" value={inputText} onChange={(e) => setInputText(e.target.value)} placeholder="សរសេរសារ..." className="flex-1 px-4 py-3 bg-gray-100 rounded-full focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition" />
                                <button disabled={!inputText.trim()} type="submit" className="p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 disabled:opacity-50 shadow-lg">{editingMessageId ? <CheckIcon className="w-5 h-5"/> : <SendIcon className="w-5 h-5"/>}</button>
                            </form>
                        </div>
                    </div>
                );
            }
            return null;
        }

        function LoginView({ onRegister, onLogin }) {
            const [mode, setMode] = useState('register'); 
            const [name, setName] = useState('');
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');

            return (
                <div className="flex items-center justify-center h-full bg-gray-50 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
                        <div className="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6"><svg className="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg></div>
                        <div className="flex bg-gray-100 rounded-lg p-1 mb-6"><button onClick={() => setMode('register')} className={`flex-1 py-2 rounded-md text-sm font-bold transition ${mode === 'register' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>ចុះឈ្មោះ</button><button onClick={() => setMode('login')} className={`flex-1 py-2 rounded-md text-sm font-bold transition ${mode === 'login' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>ចូលប្រើ</button></div>
                        {mode === 'register' ? (
                            <form onSubmit={(e) => { e.preventDefault(); onRegister(name); }}>
                                <h1 className="text-xl font-bold text-gray-800 mb-2">បង្កើតគណនីថ្មី</h1>
                                <p className="text-gray-500 mb-6 text-sm">បញ្ចូលឈ្មោះរបស់អ្នកដើម្បីចាប់ផ្តើម</p>
                                <input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="ឈ្មោះរបស់អ្នក..." className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl mb-4 focus:ring-2 focus:ring-blue-500 outline-none transition" autoFocus />
                                <button type="submit" disabled={!name.trim()} className="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl hover:bg-blue-700 transition shadow-lg disabled:opacity-50">ស្នើសុំបើកគណនី</button>
                            </form>
                        ) : (
                            <form onSubmit={(e) => { e.preventDefault(); onLogin(name, username, password); }}>
                                <h1 className="text-xl font-bold text-gray-800 mb-2">ចូលប្រើគណនី</h1>
                                <p className="text-gray-500 mb-6 text-sm">បញ្ចូលឈ្មោះ និង Username</p>
                                <input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="ឈ្មោះ..." className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl mb-3 focus:ring-2 focus:ring-blue-500 outline-none transition" />
                                <input type="text" value={username} onChange={(e) => setUsername(e.target.value)} placeholder="Username (@...)" className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl mb-3 focus:ring-2 focus:ring-blue-500 outline-none transition" />
                                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Password (ប្រសិនបើចាំបាច់)" className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl mb-4 focus:ring-2 focus:ring-blue-500 outline-none transition" />
                                <button type="submit" disabled={!name.trim() || !username.trim()} className="w-full bg-green-600 text-white font-bold py-3.5 rounded-xl hover:bg-green-700 transition shadow-lg disabled:opacity-50">ចូលប្រើ</button>
                            </form>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
