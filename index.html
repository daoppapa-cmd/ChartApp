<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khmer Chat App (Realtime DB)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Battambang for Khmer) -->
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: 'Inter', 'Battambang', sans-serif;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client?dev';
        
        // Firebase App
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        
        // --- ប្រើ Realtime Database ជំនួស Firestore ---
        import { 
            getDatabase, 
            ref, 
            push, 
            onValue, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // --- Icon Components ---
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Send = (props) => (<IconWrapper {...props}><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></IconWrapper>);
        const Paperclip = (props) => (<IconWrapper {...props}><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></IconWrapper>);
        const Video = (props) => (<IconWrapper {...props}><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></IconWrapper>);
        const FileText = (props) => (<IconWrapper {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><polyline points="10 9 9 9 8 9"/></IconWrapper>);
        const X = (props) => (<IconWrapper {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>);
        const Download = (props) => (<IconWrapper {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconWrapper>);
        const Loader2 = ({ className, size }) => (<IconWrapper className={`animate-spin ${className}`} size={size}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconWrapper>);
        const DatabaseIcon = (props) => (<IconWrapper {...props}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></IconWrapper>);

        // --- Cloudinary Config ---
        const CLOUDINARY_CLOUD_NAME = "demo"; 
        const CLOUDINARY_UPLOAD_PRESET = "docs_upload_example_us_preset"; 

        // --- Firebase Config Handling ---
        function getFirebaseConfig() {
            try {
                if (typeof __firebase_config !== 'undefined') {
                    const sysConfig = JSON.parse(__firebase_config);
                    // System config might not have databaseURL, so we handle it gracefully or rely on manual
                    return sysConfig;
                }
            } catch (e) {}

            // --- សំខាន់៖ សូមបំពេញ databaseURL របស់អ្នកនៅទីនេះ ---
            return {
                apiKey: "AIzaSyCPTS4NN_cbPggJBfDveLzBzr6nA5ziVpw",
                authDomain: "chartapp-e99be.firebaseapp.com",
                
                // សម្រាប់ Realtime Database អ្នកត្រូវតែមាន databaseURL
                // ជាធម្មតាវាមានទម្រង់: https://<PROJECT_ID>-default-rtdb.firebaseio.com
                // ឬ: https://<PROJECT_ID>-default-rtdb.asia-southeast1.firebasedatabase.app (ប្រសិនបើនៅអាស៊ី)
                databaseURL: "https://chartapp-e99be-default-rtdb.firebaseio.com/", 
                
                projectId: "chartapp-e99be",
                storageBucket: "chartapp-e99be.firebasestorage.app",
                messagingSenderId: "966338612308",
                appId: "1:966338612308:web:1feb75563c54c6be2671c1",
            };
        }

        const app = initializeApp(getFirebaseConfig());
        // Initialize Realtime Database
        const db = getDatabase(app); 

        function App() {
            // យើងលែងប្រើ auth.currentUser ពី Firebase Auth ហើយ
            // យើងបង្កើត User ID ផ្ទាល់ខ្លួនសម្រាប់ Session នេះ
            const [userId, setUserId] = useState(null);
            
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState('');
            const [attachment, setAttachment] = useState(null);
            const [isUploading, setIsUploading] = useState(false);
            const [previewUrl, setPreviewUrl] = useState(null);
            
            const messagesEndRef = useRef(null);
            const fileInputRef = useRef(null);

            // 1. Setup User ID (Guest Mode)
            useEffect(() => {
                // បង្កើត ID សម្រាប់អ្នកប្រើប្រាស់ម្នាក់ៗ (រក្សាទុកក្នុង LocalStorage ដើម្បីកុំឱ្យបាត់ពេល Refresh)
                let storedId = localStorage.getItem('chat_guest_id');
                if (!storedId) {
                    storedId = 'guest_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('chat_guest_id', storedId);
                }
                setUserId(storedId);
            }, []);

            // 2. Load Messages from Realtime Database
            useEffect(() => {
                // Reference ទៅកាន់ Path 'messages' ក្នុង Database
                const messagesRef = ref(db, 'messages');

                // ប្រើ onValue ដើម្បីស្តាប់ទិន្នន័យ (Realtime)
                const unsubscribe = onValue(messagesRef, (snapshot) => {
                    const data = snapshot.val();
                    const loadedMessages = [];
                    
                    if (data) {
                        // Realtime DB ត្រឡប់មកជា Object, មិនមែន Array ទេ
                        Object.keys(data).forEach(key => {
                            loadedMessages.push({
                                id: key,
                                ...data[key]
                            });
                        });
                    }

                    // តម្រៀបតាមពេលវេលា (timestamp)
                    loadedMessages.sort((a, b) => {
                        const t1 = a.createdAt || 0;
                        const t2 = b.createdAt || 0;
                        return t1 - t2;
                    });

                    setMessages(loadedMessages);
                    scrollToBottom();
                });

                // Cleanup function
                return () => unsubscribe(); 
            }, []);

            const scrollToBottom = () => {
                setTimeout(() => {
                    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
                }, 100);
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setAttachment(file);
                    if (file.type.startsWith('image/')) {
                        setPreviewUrl(URL.createObjectURL(file));
                    } else {
                        setPreviewUrl(null);
                    }
                }
            };

            const clearAttachment = () => {
                setAttachment(null);
                setPreviewUrl(null);
                if (fileInputRef.current) fileInputRef.current.value = '';
            };

            const uploadToCloudinary = async (file) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                let resourceType = 'auto'; 
                try {
                    const response = await fetch(
                        `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`,
                        { method: 'POST', body: formData }
                    );
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    return {
                        url: data.secure_url,
                        type: data.resource_type,
                        format: data.format,
                        originalName: file.name
                    };
                } catch (error) {
                    console.error("Upload failed:", error);
                    alert("Upload failed. Check Cloud Name/Preset.");
                    return null;
                }
            };

            const handleSend = async (e) => {
                e.preventDefault();
                if ((!inputText.trim() && !attachment) || !userId) return;

                let mediaData = null;
                if (attachment) {
                    setIsUploading(true);
                    mediaData = await uploadToCloudinary(attachment);
                    setIsUploading(false);
                    if (!mediaData) return;
                }

                try {
                    // Push data ទៅកាន់ Realtime Database
                    const messagesRef = ref(db, 'messages');
                    await push(messagesRef, {
                        text: inputText,
                        uid: userId, // ប្រើ Guest ID របស់យើង
                        createdAt: Date.now(), // Realtime DB ប្រើ Timestamp លេខធម្មតាបាន
                        media: mediaData,
                        senderId: userId.slice(0, 5)
                    });

                    setInputText('');
                    clearAttachment();
                } catch (error) {
                    console.error("Error sending message:", error);
                    alert("បរាជ័យក្នុងការផ្ញើសារ៖ " + error.message);
                }
            };

            const renderMedia = (media) => {
                if (!media) return null;
                if (media.type === 'image') {
                    return <img src={media.url} alt="sent" className="max-w-full h-auto rounded-lg mt-2 border border-gray-200" style={{ maxHeight: '200px' }} />;
                } 
                if (media.type === 'video') {
                    return <video controls className="max-w-full h-auto rounded-lg mt-2" style={{ maxHeight: '200px' }}><source src={media.url} /></video>;
                }
                return (
                    <a href={media.url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 bg-gray-100 p-3 rounded-lg mt-2 text-blue-600 hover:bg-gray-200 transition-colors">
                        <FileText size={20} /><span className="truncate max-w-[150px]">{media.originalName || 'Download File'}</span><Download size={16} />
                    </a>
                );
            };

            if (!userId) {
                return (
                    <div className="flex items-center justify-center h-screen bg-gray-50">
                        <div className="text-center">
                            <Loader2 className="mx-auto text-blue-500" size={40} />
                            <p className="mt-4 text-gray-600 font-battambang">កំពុងបង្កើតគណនី Guest...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col h-screen bg-gray-100">
                    {/* Header */}
                    <div className="bg-white shadow-sm p-4 flex items-center justify-between z-10 border-b border-gray-200">
                        <div className="flex items-center gap-2">
                            <div className="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center text-white font-bold">
                                <DatabaseIcon size={20} />
                            </div>
                            <div>
                                <h1 className="font-bold text-gray-800 text-lg font-battambang">Realtime Chat</h1>
                                <p className="text-xs text-green-600 flex items-center gap-1 font-battambang">
                                    <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                                    Database Connected
                                </p>
                            </div>
                        </div>
                        <div className="text-xs text-gray-400 font-mono">ID: {userId.slice(0, 8)}...</div>
                    </div>

                    {/* Messages Area */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {messages.length === 0 && (
                            <div className="text-center text-gray-400 mt-10 font-battambang">
                                មិនទាន់មានសារទេ។ ចាប់ផ្តើមសន្ទនា!
                            </div>
                        )}
                        {messages.map((msg) => {
                            const isMe = msg.uid === userId;
                            return (
                                <div key={msg.id} className={`flex w-full ${isMe ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[80%] md:max-w-[60%] p-3 rounded-2xl shadow-sm ${isMe ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white text-gray-800 rounded-bl-none'}`}>
                                        {!isMe && <p className="text-xs text-gray-400 mb-1 font-mono">User: {msg.senderId}</p>}
                                        {msg.text && <p className="whitespace-pre-wrap font-battambang">{msg.text}</p>}
                                        {renderMedia(msg.media)}
                                        <p className={`text-[10px] mt-1 text-right ${isMe ? 'text-blue-200' : 'text-gray-400'}`}>
                                            {msg.createdAt ? new Date(msg.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...'}
                                        </p>
                                    </div>
                                </div>
                            );
                        })}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* Input Area */}
                    <div className="bg-white p-3 border-t">
                        {attachment && (
                            <div className="flex items-center gap-3 bg-gray-50 p-2 rounded-lg mb-2 border border-blue-100">
                                {previewUrl ? <img src={previewUrl} alt="Preview" className="w-12 h-12 object-cover rounded" /> : <div className="w-12 h-12 bg-gray-200 rounded flex items-center justify-center"><FileText size={20} /></div>}
                                <div className="flex-1 min-w-0">
                                    <p className="text-sm font-medium truncate text-gray-700">{attachment.name}</p>
                                    <button onClick={clearAttachment} className="text-red-500 text-xs">លុបចេញ</button>
                                </div>
                            </div>
                        )}

                        <form onSubmit={handleSend} className="flex items-end gap-2">
                            <div className="relative">
                                <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" id="file-upload" />
                                <label htmlFor="file-upload" className={`flex items-center justify-center w-10 h-10 rounded-full cursor-pointer transition-colors ${isUploading ? 'bg-gray-100' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'}`}>
                                    {isUploading ? <Loader2 className="animate-spin" size={20} /> : <Paperclip size={20} />}
                                </label>
                            </div>
                            <div className="flex-1 bg-gray-100 rounded-2xl flex items-center px-4 py-2">
                                <input type="text" value={inputText} onChange={(e) => setInputText(e.target.value)} placeholder="សរសេរសារ..." className="w-full bg-transparent outline-none text-gray-700 placeholder-gray-500 font-battambang" disabled={isUploading} />
                            </div>
                            <button type="submit" disabled={(!inputText.trim() && !attachment) || isUploading} className={`w-10 h-10 rounded-full flex items-center justify-center text-white transition-all ${(!inputText.trim() && !attachment) || isUploading ? 'bg-blue-300' : 'bg-blue-600 hover:bg-blue-700 shadow-md'}`}>
                                <Send size={18} className={isUploading ? 'opacity-0' : 'ml-0.5'} />
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
